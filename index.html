<!DOCTYPE Posted HTML>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Planner</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* --- Global & Font --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            /* New Day A Colors (Blue) */
            --color-day-a: #3498DB;
            --color-day-a-tint: #FAFDFE;

            /* New Day B Colors (Orange) */
            --color-day-b: #ED7D31;
            --color-day-b-tint: #FFFCFA;

            /* Tracker Green Theme */
            --color-tracker-green: #58A65C;
            --color-tracker-tint: #F7FCF7;
            /* Very light green tint */

            /* New Global Colors */
            --color-text-gray: #767676;
            --color-button-green: #58A65C;
            --color-pause-purple: #9B59B6;
            /* NEW: Purple for Paused State */
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f4f7f6;
            color: #333;
            /* Main body text color */
            line-height: 1.6;
        }

        /* --- State Management: Apply colors based on active tab --- */
        body.day-a {
            --active-color: var(--color-day-a);
            --active-tint: var(--color-day-a-tint);
        }

        body.day-b {
            --active-color: var(--color-day-b);
            --active-tint: var(--color-day-b-tint);
        }

        /* NEW: Green Theme for Tracker Tabs */
        body.tracker-green {
            --active-color: var(--color-tracker-green);
            --active-tint: var(--color-tracker-tint);
        }

        /* --- Header & Tabs --- */
        .main-header {
            background-color: #ffffff;
            padding: 20px 40px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Autofill Button Styling */
        .autofill-btn {
            position: absolute;
            right: 40px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 600;
            padding: 10px 20px;
            background-color: #58A65C;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .autofill-btn.hidden {
            display: none;
        }

        h1 {
            display: none;
        }

        .tab-nav {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .tab-nav button {
            font-family: 'Montserrat', sans-serif;
            font-size: 16px;
            font-weight: 600;
            padding: 10px 30px;
            border: 2px solid transparent;
            background-color: transparent;
            cursor: pointer;
            color: #7f8c8d;
            transition: all 0.3s ease;
            border-radius: 50px;
            margin: 0 10px;
        }

        .tab-nav button:hover {
            color: #34495e;
        }

        .tab-nav button.active {
            color: var(--active-color);
            border-color: var(--active-color);
        }

        /* --- Tab Content --- */
        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* New: Full width tracker containers */
        #lessonTracker,
        #assignmentTracker {
            padding: 20px;
        }

        /* NEW: Fix Scroll Issue - Add bottom padding to main content to clear fixed footer */
        #mainContent {
            padding-bottom: 100px;
            /* Adjust based on footer height */
        }

        /* ------------------------------------------------ */
        /* NEW: Progress Bar Styling */
        /* ------------------------------------------------ */
        .progress-bar-container {
            background-color: #ffffff;
            padding: 15px 20px;
            border-radius: 12px;
            /* **MODIFIED** Change top margin to create space below the add form */
            margin-top: 25px;
            margin-bottom: 25px;
            border: 1px solid #ddd;
            display: none;
            /* Default to hidden if no data */
        }

        /* NEW: Backup Container for robust view */
        .backup-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #eee;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            text-align: left;
        }

        .progress-bar-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-tracker-green);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .progress-bar-outer {
            height: 15px;
            background-color: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .progress-bar-inner {
            height: 100%;
            background-color: var(--color-tracker-green);
            width: 0%;
            /* Will be set by JavaScript */
            transition: width 0.5s ease;
        }

        /* ------------------------------------------------ */

        .tracker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .tracker-course-card {
            background-color: var(--active-tint);
            border-radius: 25px;
            padding: 20px;
            border: 2px solid var(--active-color);
            /* **NEW:** Required for positioning the delete button */
            position: relative;
            /* **NEW:** Add smooth transition for reordering animation */
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* NEW: Paused Card Styling (Tracker) */
        .tracker-course-card.paused {
            border: 2px dashed var(--color-pause-purple);
            /* Dashed border for paused state */
            background-color: #fdfcfe;
            /* Lighter purple background */
            opacity: 0.85;
        }

        /* **NEW:** Pause Status Badge */
        .pause-badge {
            background-color: var(--color-pause-purple);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 10px;
            display: inline-block;
            vertical-align: middle;
        }

        /* **NEW:** Delete Course Card Button (Shared style for both Day A/B and Trackers) */
        .delete-course-card-btn {
            position: absolute;
            top: 27px;
            /* FIX: Perfectly centered vertically with h3 title (based on browser measurements) */
            right: 24px;
            /* FIX: Increased to account for 25px border-radius at corner */
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e74c3c;
            /* Red color */
            border: none;
            color: white;
            font-size: 16px;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            cursor: pointer;
            display: none;
            /* Default to hidden */
            padding: 0;
            transition: background-color 0.2s, opacity 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            font-family: Arial, sans-serif;
            z-index: 10;
            /* FIX: Remove default browser outline to prevent overflow on hover/focus */
            outline: none;
        }

        .delete-course-card-btn:hover {
            background-color: #c0392b;
            opacity: 0.9;
        }

        /* Class to make the button visible for Day A/B and Tracker */
        .delete-course-card-btn.completed {
            display: flex;
            /* Use flex to easily center the 'X' */
            align-items: center;
            justify-content: center;
        }

        /* MODIFIED FOR HOVER BOX CUE */
        .tracker-course-card h3 {
            font-weight: 600;
            color: var(--active-color);
            margin-bottom: 12px;
            display: block;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            padding: 5px 10px;
            border-radius: 8px;
            transition: border 0.2s ease;
            border: 2px solid transparent;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        /* NEW: Centered Underline Helper */
        .tracker-course-card h3::after,
        .course-card h3::after {
            content: "";
            display: block;
            width: 100%;
            height: 2px;
            background-color: var(--active-color);
            margin: 4px auto 0;
            opacity: 0.25;
            border-radius: 2px;
        }

        .tracker-course-card.paused h3::after,
        .course-card.paused h3::after {
            background-color: var(--color-pause-purple);
        }

        /* NEW: Hover effect with outline */
        .tracker-course-card h3:hover {
            border: 2px solid var(--active-color);
        }

        /* Paused state hover effect */
        .tracker-course-card.paused h3:hover {
            border: 2px solid var(--color-pause-purple);
        }

        /* If paused, keep purple color */
        .tracker-course-card.paused h3 {
            color: var(--color-pause-purple);
            /* Change H3 color when paused */
        }

        /* ------------------------------------------------ */
        /* PDF-Inspired Tracker List Structure */
        /* ------------------------------------------------ */
        .tracker-course-card ul {
            /* The ul is the main grid container */
            list-style: none;
            padding: 0 10px;
            /* MODIFIED: Added side padding to align with Day A/B content */
            display: grid;
            /* 1fr for Name, 60px for Status, 80px for Actions */
            grid-template-columns: 1fr 60px 80px;
            gap: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }

        /* Grid Header Row */
        .tracker-grid-header {
            font-weight: 600;
            color: #555;
            padding: 8px 0;
            border-bottom: 2px solid var(--active-color);
            margin-bottom: 5px;
            grid-column: 1 / -1;
            /* Span all columns */
            display: contents;
            /* Allow children to be grid items */
        }

        /* Center Status and Actions headers */
        .tracker-grid-header>div:nth-child(2),
        .tracker-grid-header>div:nth-child(3) {
            text-align: center;
        }

        /* Individual list item row */
        .tracker-item-row {
            display: contents;
            /* Allows children to be direct grid items */
        }

        .tracker-item-row>div {
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            align-self: center;
            /* Vertically align */
        }

        /* NEW: Centering for the Status (col 2) and Actions (col 3) columns */
        .tracker-item-row>div:nth-child(2),
        .tracker-item-row>div:nth-child(3) {
            display: flex;
            /* Use flexbox for perfect vertical and horizontal centering of children */
            align-items: center;
            justify-content: center;
        }

        /* Remove bottom border on the last item in the list */
        .tracker-course-card ul>div:last-of-type>div:nth-child(1),
        .tracker-course-card ul>div:last-of-type>div:nth-child(2),
        .tracker-course-card ul>div:last-of-type>div:nth-child(3) {
            border-bottom: none;
        }

        .tracker-item-name {
            font-weight: 500;
            word-break: break-word;
        }

        /* Delete Button (individual task) */
        .delete-btn {
            padding: 5px 10px;
            background-color: #e74c3c;
            /* Red color */
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: background-color 0.2s;
            width: 60px;
            /* fixed width for button */

            /* NEW: Font fix */
            font-family: 'Montserrat', sans-serif;
        }

        .delete-btn:hover {
            background-color: #c0392b;
        }

        /* ------------------------------------------------ */

        .tracker-course-card li {
            /* Keep existing li but make it not show up in the new grid layout */
            display: none;
        }

        /* New: Pie Chart Container */
        .chart-container {
            width: 150px;
            height: 150px;
            margin: 15px auto 0;
        }

        /* Add Items Trigger Button */
        .add-items-trigger-btn {
            display: block;
            margin: 0 auto 0;
            padding: 12px 28px;
            font-family: 'Montserrat', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: white;
            background-color: var(--color-button-green);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-items-trigger-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(88, 166, 92, 0.35);
        }

        /* Add Items Modal (extends link-modal pattern) */
        .add-items-modal-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            margin-bottom: 20px;
            box-sizing: border-box;
            resize: none;
            overflow: hidden;
            min-height: 80px;
            line-height: 1.5;
        }

        .add-items-modal-textarea:hover,
        .add-items-modal-textarea:focus {
            outline: none;
            border-color: var(--color-tracker-green);
            box-shadow: 0 0 0 1px var(--color-tracker-green);
        }

        .add-items-modal-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            margin-bottom: 15px;
            box-sizing: border-box;
            background-color: #fff;
            cursor: pointer;
        }

        .add-items-modal-select:hover,
        .add-items-modal-select:focus {
            outline: none;
            border-color: var(--color-tracker-green);
            box-shadow: 0 0 0 1px var(--color-tracker-green);
        }

        /* Hide old form elements (no longer used in HTML) */
        .add-new-form,
        .add-single-section,
        .form-divider {
            display: none !important;
        }

        .tracker-summary {
            /* NEW: Ensure space below the H3 hover box */
            margin-top: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        /* Canvas Import & Multi-Assignment CSS */
        .canvas-tree-item {
            margin-left: 20px;
            border-left: 2px solid #ddd;
            padding-left: 10px;
            line-height: 1.5;
            padding-bottom: 4px;
        }

        .canvas-tree-lesson {
            font-weight: 700;
            color: #2c3e50;
            margin-top: 8px;
            border-left: none;
            /* Lessons are top level in tree */
            margin-left: 0;
        }

        .canvas-tree-assignment {
            color: #e67e22;
        }

        .canvas-tree-discussion {
            color: #3498db;
        }

        .canvas-tree-quiz {
            color: #9b59b6;
        }

        .canvas-tree-type {
            font-size: 0.85em;
            text-transform: uppercase;
            font-weight: 600;
            opacity: 0.7;
            margin-right: 6px;
        }

        /* Multi-Assignment Connector Lines */
        .task-list li {
            position: relative;
            /* Context for absolute lines */
        }

        .task-group-container {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .task-assignments-container {
            display: flex;
            flex-direction: column;
            gap: 6px;
            /* Space between multiple assignments */
            margin-top: 4px;
            position: relative;
        }

        /* Visual connector line linking Lesson to Assignments */
        .task-connector-line {
            position: absolute;
            left: 12px;
            /* Align with center of checkbox/bullet area roughly */
            top: 40px;
            /* Start below lesson */
            bottom: 20px;
            width: 2px;
            background-color: #eee;
            z-index: 0;
            display: none;
            /* Hidden by default, shown via JS if multiple assignments */
        }

        .has-multiple-assignments .task-connector-line {
            display: block;
        }

        .has-multiple-assignments .task-assignment-main {
            padding-left: 30px;
            /* Indent using padding so hover area includes the X button */
            margin-left: 0;
        }

        .task-assignment-main {
            position: relative;
        }

        #canvas-preview-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 15px;
        }

        #canvas-preview-container.no-indent .canvas-tree-item {
            margin-left: 0 !important;
            padding-left: 0 !important;
            border-left: none !important;
        }

        .task-remove-assignment-btn {
            display: none;
            /* Hidden by default */
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            margin: 0;
            position: absolute;
            left: 5px;
            /* Position inside the padding area */
            top: 50%;
            transform: translateY(-50%);
            z-index: 20;
            pointer-events: auto;
        }

        /* Show removal button on moused over ONLY if multiple assignments/lesson items exist */
        /* Per user request: "remove this functionality entirely for single assignments" */
        .has-multiple-assignments .task-assignment-main:hover .task-remove-assignment-btn,
        .task-assignments-container:has(.task-assignment-main:nth-child(2)) .task-assignment-main:hover .task-remove-assignment-btn {
            display: inline-block;
        }

        /* Specifically allow hiding for the absolute first assignment if we ever want to revert, 
           but per user request: "X icon should also appear for the first assignment within the indented assignments." */

        .task-remove-assignment-btn:hover {
            color: #e74c3c;
        }

        /* FIX: Ensure assignment text is black, but reset/placeholder is gray */
        .task-assignment-name {
            color: #000 !important;
        }

        .task-assignment-name::placeholder {
            color: #757575 !important;
            -webkit-text-fill-color: #757575 !important;
            opacity: 1;
        }



        /* --- Course Grid & Cards --- */
        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            /* **FIX:** Prevent cards from stretching to match the tallest one */
            align-items: start;
        }

        .course-card {
            background-color: var(--active-tint);
            border-radius: 25px;
            box-shadow: none;
            padding: 20px;
            border: 2px solid var(--active-color);
            position: relative;
            /* REQUIRED for delete button */
            /* **NEW:** Add smooth transition for reordering animation */
            transition: opacity 0.3s ease, transform 0.3s ease;

            /* **FIX:** Removed fixed height and flex layout to allow content-driven height */
            /* **FIX:** Add max-width to prevent card expansion with long URLs */
            max-width: 600px;
        }

        /* NEW: Paused Day Card Styling (Matches Tracker Card) */
        .course-card.paused {
            border: 2px dashed var(--color-pause-purple);
            background-color: #fdfcfe;
            /* Light purple background */
            opacity: 0.85;
        }

        /* NEW: Header Color on Paused Day Card */
        .course-card.paused h3 {
            color: var(--color-pause-purple);
        }

        /* NEW: Text Color Override for Paused Day Card Fields */
        .course-card.paused .task-list textarea,
        .course-card.paused .task-link {
            /* Text Color */
            color: var(--color-text-gray) !important;
            /* Placeholder Color (for consistency) */
            opacity: 1;
            /* Fully opaque */
        }

        /* NEW: Placeholder Color for Paused Day Card Fields */
        .course-card.paused .task-list textarea::placeholder,
        .course-card.paused .task-link::placeholder {
            color: var(--color-text-gray);
            opacity: 0.5;
        }

        /* NEW: Theme Label Color for Paused Day Card Fields */
        .course-card.paused .task-type-label {
            color: var(--color-pause-purple);
        }

        /* NEW: Delete Button on Day A/B Cards */
        .course-card .delete-course-card-btn {
            background-color: #e74c3c;
            /* Red color */
            color: white;
        }

        .course-card h3 {
            font-weight: 600;
            color: var(--active-color);
            margin-bottom: 15px;
            display: block;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            padding: 5px 10px;
            border-radius: 8px;
            transition: border 0.2s ease;
            cursor: pointer;
            user-select: none;
            border: 2px solid transparent;
            position: relative;
        }

        .course-card h3:hover {
            border: 2px solid var(--active-color);
        }

        /* **NEW:** Style for course link anchor tags */
        .course-card h3 a.course-link,
        .tracker-course-card h3 a.course-link {
            color: inherit;
            text-decoration: none;
        }

        .course-card.paused h3:hover {
            border: 2px solid var(--color-pause-purple);
        }

        .course-card .course-notes {
            display: none;
        }

        /* --- Task List Items --- */
        .task-list {
            list-style: none;
            margin-top: 10px;
        }

        .task-list li {
            margin-bottom: 0;
            padding: 5px 0;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        /* NEW WRAPPER FOR SCROLLING CONTENT */
        .course-content-scroll-area {
            /* **FIX:** Re-introduced max-height to ensure scrolling works when content exceeds this size */
            max-height: 550px;
            overflow-y: auto;
            /* Enable vertical scrolling when content exceeds available height */
            padding-right: 10px;
            padding-left: 10px;
            /* **FIX:** Added left padding to balance right padding and center content */

            /* flex-grow removed */
        }


        /* Updated Grid for Lesson/Assignment Label + Name + Checkbox */
        .task-main {
            display: grid;
            /* Label (100px) | Name Wrapper (1fr) | Checkbox (auto) */
            grid-template-columns: 100px 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .task-type-label {
            font-weight: 600;
            color: var(--active-color);
            /* Highlight the type */
            align-self: center;
            flex-shrink: 0;
        }

        /* New wrapper for name input and suggestions (1. Search Positioning Fix) */
        .task-name-wrapper {
            position: relative;
            /* Set context for absolute suggestions */
            align-self: center;
        }

        .task-notes-row,
        .link-input-row {
            margin-top: 10px;
        }

        /* Styling for new TEXTAREAS (task-name and task-notes) and input (task-link) */
        .task-list textarea,
        .task-link {
            font-family: 'Montserrat', sans-serif;
            color: var(--color-text-gray);
            font-size: 14px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #ffffff;
            line-height: 1.6;
            width: 100%;
            resize: none;
            /* Disable manual resize */
            overflow: hidden;
            /* Hide scrollbars, JS manages height */
            min-height: 38px;
            /* Standard minimum height for both notes and task names */
        }

        /* Specific font weight for the lesson/assignment name fields */
        .task-name {
            font-weight: 500;
        }

        /* Specific font weight for the notes field */
        .task-notes {
            font-weight: 400;
        }

        /* Specific Link Input Font Size (Value) */
        .task-link {
            font-size: 13px;
            min-height: 38px;
            /* Keep consistent height */
            /* **FIX:** Prevent card expansion with long URLs */
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Specific Link Input Font Size (Placeholder) */
        .task-link::placeholder {
            font-size: 13px;
            opacity: 0.9;
        }

        /* Hover effect for all fields */
        .task-list textarea:hover,
        .task-link:hover {
            border-color: var(--active-color);
            /* FIX: Removed box-shadow to prevent vertical line artifact on right side */
        }

        /* **NEW:** Paused Card Field Hover Effects (Purple) */
        .course-card.paused .task-list textarea:hover,
        .course-card.paused .task-link:hover {
            border-color: var(--color-pause-purple);
            /* FIX: Removed box-shadow to prevent vertical line artifact */
        }

        /* --- Checkbox --- */
        .task-list input[type="checkbox"],
        .tracker-item-checkbox {
            width: 25px;
            height: 25px;
            cursor: pointer;
            justify-self: end;
            border-radius: 25px;
            border: 2px solid var(--color-text-gray);
            background-color: #fff;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            transition: all 0.2s ease;
            background-repeat: no-repeat;
            background-position: center;
            background-size: 60%;
        }

        /* NEW: Checkbox Hover Effect */
        .task-list input[type="checkbox"]:hover,
        .tracker-item-checkbox:hover {
            border-color: var(--active-color);
            box-shadow: 0 0 0 1px var(--active-color);
        }

        .task-list input[type="checkbox"]:checked,
        .tracker-item-checkbox:checked {
            background-color: #ffffff;
            border-color: var(--active-color);
            /* Black checkmark (âœ“) */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='black' d='M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z'/%3E%3C/svg%3E");
        }

        .tracker-item-row .tracker-item-checkbox {
            /* margin: 0 auto; Removed, relying on flex parent */
        }


        /* --- Embed/Link Display Area Styling --- */
        .course-embed-container {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: none;
            flex-shrink: 0;
            /* Prevent the embed container from taking up all space */
        }

        .video-embed-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 12px;
            transform: translateZ(0);
            /* Removed margin-bottom here, added inline in JS for flexibility */
        }

        .video-embed-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .course-embed-container a {
            display: block;
            padding: 5px 0;
            color: var(--active-color);
            font-weight: 600;
            text-decoration: none;
            word-wrap: break-word;
        }

        /* New: Search Suggestions (2. Positioning Fix) */
        .search-suggestions {
            position: absolute;
            z-index: 10;
            top: 100%;
            /* Position correctly below the input */
            left: 0;
            right: 0;
            background-color: #ffffff;
            border: 1px solid var(--active-color);
            border-top: none;
            /* Make it visually connect to the input border */
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
            display: none;
        }

        .search-suggestions.active {
            display: block;
        }

        .search-suggestions li {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            color: #333;
            font-size: 14px;
        }

        .search-suggestions li:last-child {
            border-bottom: none;
        }

        .search-suggestions li:hover {
            background-color: var(--active-tint);
        }

        /* --- Footer & Buttons (Fixed Position) --- */
        .main-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            flex-shrink: 0;
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
            padding: 15px 30px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }

        .footer-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .footer-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
        }

        .footer-divider {
            width: 1px;
            height: 24px;
            background-color: #e0e0e0;
            margin: 0 8px;
        }

        .main-footer .footer-title {
            display: block;
            font-size: 22px;
            font-weight: 600;
            color: #2c3e50;
            position: relative;
            /* Established context for tooltip */
            cursor: default;
        }

        /* **NEW:** Version Tooltip Styling */
        .main-footer .footer-title:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            /* Position above the text */
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            animation: fadeIn 0.2s forwards;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            from {
                opacity: 0;
                transform: translateX(-50%) translateY(5px);
            }
        }

        .main-footer button {
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ffffff;
            flex-shrink: 0;

            border: 1px solid;
            padding: 8px 16px;
            border-radius: 12px;

            transition: all 0.2s ease;
        }

        .main-footer button:hover {
            opacity: 0.85;
        }

        /* Button Group 1: Lesson & Assignment Tracker (Green) */
        #lessonTrackerBtn,
        #assignmentTrackerBtn {
            color: var(--color-button-green);
            border-color: var(--color-button-green);
        }

        /* Button Group 2: Reset & Save (Theme Color) */
        #saveBtn,
        #resetBtn {
            color: var(--active-color);
            border-color: var(--active-color);
        }

        /* Button Group 3: Backup Navigation (Plain Black Outline) */
        #backupBtn {
            color: #000000;
            border: 1px solid #000000;
        }

        /* **NEW:** Canvas Branding */
        #canvas-import-btn {
            background-color: #e72429;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 14px;
        }

        #canvas-import-btn:hover {
            background-color: #d11e23;
            opacity: 1;
        }

        #canvas-import-btn svg {
            width: 18px;
            height: 18px;
            fill: white;
            flex-shrink: 0;
        }

        /* Red branding for the Canvas Modal buttons and hovers */
        #canvasImportModal .btn-save,
        #canvasImportModal .btn-cancel,
        #canvas-import-action-btn,
        #canvas-preview-btn {
            background-color: #e72429 !important;
            border-color: #e72429 !important;
            color: white !important;
        }

        #canvasImportModal .btn-save:hover,
        #canvasImportModal .btn-cancel:hover,
        #canvas-import-action-btn:hover,
        #canvas-preview-btn:hover {
            background-color: #d11e23 !important;
            opacity: 1 !important;
        }

        /* Ensure textarea and select hover borders are also red in Canvas modal */
        #canvasImportModal .add-items-modal-textarea:focus,
        #canvasImportModal .add-items-modal-select:focus {
            border-color: #e72429 !important;
            box-shadow: 0 0 0 1px #e72429 !important;
        }

        /* Manual Indentation Class (Harmonized to 24px) */
        .manual-indent {
            padding-left: 24px !important;
            margin-left: 0 !important;
        }

        /* Forced Outdenting for pre-indented items */
        .force-no-indent {
            padding-left: 0 !important;
            margin-left: 0 !important;
        }

        .task-type-label,
        .canvas-tree-type {
            cursor: pointer;
            user-select: none;
        }

        .task-type-label:hover,
        .canvas-tree-type:hover {
            text-decoration: underline;
            opacity: 0.8;
        }

        /* Save Confirmation State for UX Feedback */
        #saveBtn.saved-state {
            color: var(--color-button-green);
            border-color: var(--color-button-green);
        }

        /* **NEW:** Custom Context Menu Styling */
        .context-menu {
            position: fixed;
            z-index: 1000;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            /* REMOVED: Initial left/top styling */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            padding: 5px 0;
            min-width: 150px;
            font-size: 14px;
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            color: #333;
            transition: background-color 0.1s;
        }

        .context-menu-item:hover {
            background-color: var(--active-tint);
        }

        /* Specific color for the pause action */
        .context-menu-item.pause-action {
            color: var(--color-pause-purple);
            font-weight: 600;
        }

        /* **NEW:** Custom Link Preview Card Styling */
        .course-link-preview {
            margin-top: 15px;
            padding: 12px;
            background-color: #ffffff;
            border: 1px solid var(--active-color);
            border-radius: 8px;
            display: none;
            flex-shrink: 0;
        }

        .course-link-preview.active {
            display: block;
        }

        .preview-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .preview-thumbnail {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            background-color: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
        }

        .preview-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-content {
            flex: 1;
            min-width: 0;
        }

        .preview-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .preview-description {
            font-size: 13px;
            color: #767676;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .preview-url {
            font-size: 12px;
            color: var(--active-color);
            text-decoration: none;
            word-break: break-all;
        }

        .preview-url:hover {
            text-decoration: underline;
        }

        .preview-loading {
            text-align: center;
            color: #767676;
            font-size: 13px;
            padding: 10px 0;
        }

        /* **NEW:** Link Modal Dialog Styling */
        .link-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .link-modal-overlay.active {
            display: flex;
        }

        .link-modal {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .link-modal h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .link-modal .course-name {
            font-size: 14px;
            color: #767676;
            margin-bottom: 20px;
        }

        .link-modal-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .link-modal-input:hover,
        .link-modal-input:focus {
            outline: none;
            border-color: var(--active-color);
            box-shadow: 0 0 0 1px var(--active-color);
        }

        .link-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .link-modal-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .link-modal-buttons .btn-cancel {
            background-color: #f0f0f0;
            color: #333;
        }

        .link-modal-buttons .btn-cancel:hover {
            background-color: #e0e0e0;
        }

        .link-modal-buttons .btn-save {
            background-color: var(--active-color);
            color: white;
        }

        .link-modal-buttons .btn-save:hover {
            opacity: 0.9;
        }

        /* **NEW:** Context Menu Item Specific Colors */
        .context-menu-item.link-action {
            color: var(--active-color);
            font-weight: 600;
        }

        /* **NEW:** Split Assignment Feature Styles */
        .context-menu-item.split-action {
            color: var(--color-tracker-green);
            font-weight: 600;
        }

        .context-menu-item.complete-action {
            color: var(--color-tracker-green);
        }

        .context-menu-item.reset-action {
            color: var(--color-tracker-green);
        }

        /* Progress Circle Wrapper - matches original checkbox size */
        .progress-circle-wrapper {
            position: relative;
            width: 25px;
            height: 25px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 25px;
            background-color: #fff;
            /* Match regular checkbox border exactly for zoom consistency */
            border: 2px solid #767676;
            transition: all 0.2s ease;
        }

        .progress-circle-wrapper:hover {
            border-color: var(--active-color);
            box-shadow: 0 0 0 1px var(--active-color);
        }

        /* SVG Progress Circle - overlays on top */
        .progress-circle-svg {
            position: absolute;
            top: -2px;
            left: -2px;
            width: calc(100% + 4px);
            height: calc(100% + 4px);
            transform: rotate(-90deg);
            pointer-events: none;
        }

        .progress-circle-bg {
            fill: none;
            stroke: transparent;
            stroke-width: 2;
        }

        .progress-circle-progress {
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s ease, stroke 0.3s ease;
        }

        /* In-progress state - Orange arc */
        .progress-circle-progress.in-progress {
            stroke: #F39C12;
        }

        /* Completed state - Day A Blue */
        .progress-circle-progress.completed-day-a {
            stroke: var(--color-day-a);
        }

        /* Completed state - Day B Orange */
        .progress-circle-progress.completed-day-b {
            stroke: var(--color-day-b);
        }

        /* Completed state - Tracker Green */
        .progress-circle-progress.completed-tracker {
            stroke: var(--color-tracker-green);
        }

        /* Completed wrapper gets colored border */
        .progress-circle-wrapper.completed {
            border-color: var(--active-color);
        }

        /* Explicit border colors for Day A/B cards when completed */
        .progress-circle-wrapper.completed-day-a {
            border-color: var(--color-day-a);
        }

        .progress-circle-wrapper.completed-day-b {
            border-color: var(--color-day-b);
        }

        /* Hidden checkbox for split assignments */
        .split-assignment-checkbox {
            opacity: 0;
            position: absolute;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 10;
        }

        /* Checkmark inside progress circle - uses same SVG as original checkbox */
        .progress-circle-checkmark {
            position: absolute;
            width: 60%;
            height: 60%;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='black' d='M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Split Assignment Modal */
        .split-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .split-modal-overlay.active {
            display: flex;
        }

        .split-modal {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .split-modal h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .split-modal .assignment-info {
            font-size: 14px;
            color: #767676;
            margin-bottom: 20px;
        }

        .split-modal label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .split-modal-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Montserrat', sans-serif;
            font-size: 16px;
            margin-bottom: 20px;
            box-sizing: border-box;
            text-align: center;
        }

        .split-modal-input:hover,
        .split-modal-input:focus {
            outline: none;
            border-color: var(--color-tracker-green);
            box-shadow: 0 0 0 1px var(--color-tracker-green);
        }

        .split-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .split-modal-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .split-modal-buttons .btn-cancel {
            background-color: #f0f0f0;
            color: #333;
        }

        .split-modal-buttons .btn-cancel:hover {
            background-color: #e0e0e0;
        }

        .split-modal-buttons .btn-split {
            background-color: var(--color-tracker-green);
            color: white;
        }

        .split-modal-buttons .btn-split:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body class="day-a">

    <header class="main-header">
        <nav class="tab-nav">
            <button class="tab-link active" data-tab="dayA">Day A</button>
            <button class="tab-link" data-tab="dayB">Day B</button>
        </nav>
        <button id="autofillBtn" class="autofill-btn hidden"
            title="Auto-fill this day with next unfinished lessons and assignments">
            Autofill
        </button>
    </header>

    <main id="mainContent">
        <div id="dayA" class="tab-content active">
            <div class="course-grid">
                <div class="course-card" data-course-name="Advanced Functions" data-day="dayA">
                    <h3>Advanced Functions</h3>
                    <button class="delete-course-card-btn" data-course="Advanced Functions" data-day="dayA"
                        title="Clear all tasks in this card">
                        &times;
                    </button>
                    <div class="course-content-scroll-area">
                        <ul class="task-list">
                            <li>
                                <div class="task-main task-lesson-main">
                                    <div class="task-type-label">Lesson:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-lesson-name"
                                            placeholder="Lesson Name"></textarea>
                                        <ul class="search-suggestions task-lesson-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-lesson-checkbox">
                                </div>

                                <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

                                <div class="task-main task-assignment-main">
                                    <div class="task-type-label"><span class="task-type-text">Assignment</span>:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-assignment-name"
                                            placeholder="Assignment Name"></textarea>
                                        <ul class="search-suggestions task-assignment-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-assignment-checkbox">
                                </div>

                                <div class="task-notes-row">
                                    <textarea class="task-notes" placeholder="Notes"></textarea>
                                </div>
                                <div class="link-input-row">
                                    <input type="text" class="task-link" placeholder="Paste link here...">
                                </div>
                            </li>
                        </ul>
                        <div class="course-embed-container"></div>
                    </div>
                </div>

                <div class="course-card" data-course-name="Data Management" data-day="dayA">
                    <h3>Data Management</h3>
                    <button class="delete-course-card-btn" data-course="Data Management" data-day="dayA"
                        title="Clear all tasks in this card">
                        &times;
                    </button>
                    <div class="course-content-scroll-area">
                        <ul class="task-list">
                            <li>
                                <div class="task-main task-lesson-main">
                                    <div class="task-type-label">Lesson:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-lesson-name"
                                            placeholder="Lesson Name"></textarea>
                                        <ul class="search-suggestions task-lesson-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-lesson-checkbox">
                                </div>

                                <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

                                <div class="task-main task-assignment-main">
                                    <div class="task-type-label"><span class="task-type-text">Assignment</span>:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-assignment-name"
                                            placeholder="Assignment Name"></textarea>
                                        <ul class="search-suggestions task-assignment-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-assignment-checkbox">
                                </div>

                                <div class="task-notes-row">
                                    <textarea class="task-notes" placeholder="Notes"></textarea>
                                </div>
                                <div class="link-input-row">
                                    <input type="text" class="task-link" placeholder="Paste link here...">
                                </div>
                            </li>
                        </ul>
                        <div class="course-embed-container"></div>
                    </div>
                </div>

                <div class="course-card" data-course-name="English" data-day="dayA">
                    <h3>English</h3>
                    <button class="delete-course-card-btn" data-course="English" data-day="dayA"
                        title="Clear all tasks in this card">
                        &times;
                    </button>
                    <div class="course-content-scroll-area">
                        <ul class="task-list">
                            <li>
                                <div class="task-main task-lesson-main">
                                    <div class="task-type-label">Lesson:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-lesson-name"
                                            placeholder="Lesson Name"></textarea>
                                        <ul class="search-suggestions task-lesson-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-lesson-checkbox">
                                </div>

                                <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

                                <div class="task-main task-assignment-main">
                                    <div class="task-type-label"><span class="task-type-text">Assignment</span>:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-assignment-name"
                                            placeholder="Assignment Name"></textarea>
                                        <ul class="search-suggestions task-assignment-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-assignment-checkbox">
                                </div>

                                <div class="task-notes-row">
                                    <textarea class="task-notes" placeholder="Notes"></textarea>
                                </div>
                                <div class="link-input-row">
                                    <input type="text" class="task-link" placeholder="Paste link here...">
                                </div>
                            </li>
                        </ul>
                        <div class="course-embed-container"></div>
                    </div>
                </div>

                <div class="course-card" data-course-name="Economics" data-day="dayA">
                    <h3>Economics</h3>
                    <button class="delete-course-card-btn" data-course="Economics" data-day="dayA"
                        title="Clear all tasks in this card">
                        &times;
                    </button>
                    <div class="course-content-scroll-area">
                        <ul class="task-list">
                            <li>
                                <div class="task-main task-lesson-main">
                                    <div class="task-type-label">Lesson:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-lesson-name"
                                            placeholder="Lesson Name"></textarea>
                                        <ul class="search-suggestions task-lesson-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-lesson-checkbox">
                                </div>

                                <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

                                <div class="task-main task-assignment-main">
                                    <div class="task-type-label"><span class="task-type-text">Assignment</span>:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-assignment-name"
                                            placeholder="Assignment Name"></textarea>
                                        <ul class="search-suggestions task-assignment-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-assignment-checkbox">
                                </div>

                                <div class="task-notes-row">
                                    <textarea class="task-notes" placeholder="Notes"></textarea>
                                </div>
                                <div class="link-input-row">
                                    <input type="text" class="task-link" placeholder="Paste link here...">
                                </div>
                            </li>
                        </ul>
                        <div class="course-embed-container"></div>
                    </div>
                </div>

                <div class="course-card" data-course-name="Media Arts" data-day="dayA">
                    <h3>Media Arts</h3>
                    <button class="delete-course-card-btn" data-course="Media Arts" data-day="dayA"
                        title="Clear all tasks in this card">
                        &times;
                    </button>
                    <div class="course-content-scroll-area">
                        <ul class="task-list">
                            <li>
                                <div class="task-main task-lesson-main">
                                    <div class="task-type-label">Lesson:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-lesson-name"
                                            placeholder="Lesson Name"></textarea>
                                        <ul class="search-suggestions task-lesson-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-lesson-checkbox">
                                </div>

                                <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

                                <div class="task-main task-assignment-main">
                                    <div class="task-type-label"><span class="task-type-text">Assignment</span>:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-assignment-name"
                                            placeholder="Assignment Name"></textarea>
                                        <ul class="search-suggestions task-assignment-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-assignment-checkbox">
                                </div>

                                <div class="task-notes-row">
                                    <textarea class="task-notes" placeholder="Notes"></textarea>
                                </div>
                                <div class="link-input-row">
                                    <input type="text" class="task-link" placeholder="Paste link here...">
                                </div>
                            </li>
                        </ul>
                        <div class="course-embed-container"></div>
                    </div>
                </div>

            </div>
        </div>

        <div id="dayB" class="tab-content">
            <div class="course-grid">
                <div class="course-card" data-course-name="Advanced Functions" data-day="dayB">
                    <h3>Advanced Functions</h3>
                    <button class="delete-course-card-btn" data-course="Advanced Functions" data-day="dayB"
                        title="Clear all tasks in this card">
                        &times;
                    </button>
                    <div class="course-content-scroll-area">
                        <ul class="task-list">
                            <li>
                                <div class="task-main task-lesson-main">
                                    <div class="task-type-label">Lesson:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-lesson-name"
                                            placeholder="Lesson Name"></textarea>
                                        <ul class="search-suggestions task-lesson-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-lesson-checkbox">
                                </div>

                                <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

                                <div class="task-main task-assignment-main">
                                    <div class="task-type-label"><span class="task-type-text">Assignment</span>:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-assignment-name"
                                            placeholder="Assignment Name"></textarea>
                                        <ul class="search-suggestions task-assignment-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-assignment-checkbox">
                                </div>

                                <div class="task-notes-row">
                                    <textarea class="task-notes" placeholder="Notes"></textarea>
                                </div>
                                <div class="link-input-row">
                                    <input type="text" class="task-link" placeholder="Paste link here...">
                                </div>
                            </li>
                        </ul>
                        <div class="course-embed-container"></div>
                    </div>
                </div>

                <div class="course-card" data-course-name="Data Management" data-day="dayB">
                    <h3>Data Management</h3>
                    <button class="delete-course-card-btn" data-course="Data Management" data-day="dayB"
                        title="Clear all tasks in this card">
                        &times;
                    </button>
                    <div class="course-content-scroll-area">
                        <ul class="task-list">
                            <li>
                                <div class="task-main task-lesson-main">
                                    <div class="task-type-label">Lesson:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-lesson-name"
                                            placeholder="Lesson Name"></textarea>
                                        <ul class="search-suggestions task-lesson-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-lesson-checkbox">
                                </div>

                                <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

                                <div class="task-main task-assignment-main">
                                    <div class="task-type-label"><span class="task-type-text">Assignment</span>:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-assignment-name"
                                            placeholder="Assignment Name"></textarea>
                                        <ul class="search-suggestions task-assignment-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-assignment-checkbox">
                                </div>

                                <div class="task-notes-row">
                                    <textarea class="task-notes" placeholder="Notes"></textarea>
                                </div>
                                <div class="link-input-row">
                                    <input type="text" class="task-link" placeholder="Paste link here...">
                                </div>
                            </li>
                        </ul>
                        <div class="course-embed-container"></div>
                    </div>
                </div>

                <div class="course-card" data-course-name="Business Leadership" data-day="dayB">
                    <h3>Business Leadership</h3>
                    <button class="delete-course-card-btn" data-course="Business Leadership" data-day="dayB"
                        title="Clear all tasks in this card">
                        &times;
                    </button>
                    <div class="course-content-scroll-area">
                        <ul class="task-list">
                            <li>
                                <div class="task-main task-lesson-main">
                                    <div class="task-type-label">Lesson:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-lesson-name"
                                            placeholder="Lesson Name"></textarea>
                                        <ul class="search-suggestions task-lesson-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-lesson-checkbox">
                                </div>

                                <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

                                <div class="task-main task-assignment-main">
                                    <div class="task-type-label"><span class="task-type-text">Assignment</span>:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-assignment-name"
                                            placeholder="Assignment Name"></textarea>
                                        <ul class="search-suggestions task-assignment-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-assignment-checkbox">
                                </div>

                                <div class="task-notes-row">
                                    <textarea class="task-notes" placeholder="Notes"></textarea>
                                </div>
                                <div class="link-input-row">
                                    <input type="text" class="task-link" placeholder="Paste link here...">
                                </div>
                            </li>
                        </ul>
                        <div class="course-embed-container"></div>
                    </div>
                </div>

                <div class="course-card" data-course-name="Challenge & Change" data-day="dayB">
                    <h3>Challenge & Change</h3>
                    <button class="delete-course-card-btn" data-course="Challenge & Change" data-day="dayB"
                        title="Clear all tasks in this card">
                        &times;
                    </button>
                    <div class="course-content-scroll-area">
                        <ul class="task-list">
                            <li>
                                <div class="task-main task-lesson-main">
                                    <div class="task-type-label">Lesson:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-lesson-name"
                                            placeholder="Lesson Name"></textarea>
                                        <ul class="search-suggestions task-lesson-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-lesson-checkbox">
                                </div>

                                <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

                                <div class="task-main task-assignment-main">
                                    <div class="task-type-label"><span class="task-type-text">Assignment</span>:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-assignment-name"
                                            placeholder="Assignment Name"></textarea>
                                        <ul class="search-suggestions task-assignment-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-assignment-checkbox">
                                </div>

                                <div class="task-notes-row">
                                    <textarea class="task-notes" placeholder="Notes"></textarea>
                                </div>
                                <div class="link-input-row">
                                    <input type="text" class="task-link" placeholder="Paste link here...">
                                </div>
                            </li>
                        </ul>
                        <div class="course-embed-container"></div>
                    </div>
                </div>

                <div class="course-card" data-course-name="Ontario Literacy Course" data-day="dayB">
                    <h3>Ontario Literacy Course</h3>
                    <button class="delete-course-card-btn" data-course="Ontario Literacy Course" data-day="dayB"
                        title="Clear all tasks in this card">
                        &times;
                    </button>
                    <div class="course-content-scroll-area">
                        <ul class="task-list">
                            <li>
                                <div class="task-main task-lesson-main">
                                    <div class="task-type-label">Lesson:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-lesson-name"
                                            placeholder="Lesson Name"></textarea>
                                        <ul class="search-suggestions task-lesson-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-lesson-checkbox">
                                </div>

                                <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">

                                <div class="task-main task-assignment-main">
                                    <div class="task-type-label"><span class="task-type-text">Assignment</span>:</div>
                                    <div class="task-name-wrapper">
                                        <textarea class="task-name task-assignment-name"
                                            placeholder="Assignment Name"></textarea>
                                        <ul class="search-suggestions task-assignment-suggestions"></ul>
                                    </div>
                                    <input type="checkbox" class="task-checkbox task-assignment-checkbox">
                                </div>

                                <div class="task-notes-row">
                                    <textarea class="task-notes" placeholder="Notes"></textarea>
                                </div>
                                <div class="link-input-row">
                                    <input type="text" class="task-link" placeholder="Paste link here...">
                                </div>
                            </li>
                        </ul>
                        <div class="course-embed-container"></div>
                    </div>
                </div>

            </div>
        </div>

        <div id="lessonTracker" class="tab-content">
            <button id="openAddLessonModal" class="add-items-trigger-btn">Add Lessons</button>

            <div id="lessonOverallProgress" class="progress-bar-container"></div>

            <div id="lessonTrackerContent" class="tracker-grid">
            </div>
        </div>

        <div id="assignmentTracker" class="tab-content">
            <button id="openAddAssignmentModal" class="add-items-trigger-btn">Add Assignments</button>

            <div id="assignmentOverallProgress" class="progress-bar-container"></div>

            <div id="assignmentTrackerContent" class="tracker-grid">
            </div>
        </div>

        <!-- Backup & Restore Tab Content -->
        <div id="backupTab" class="tab-content">
            <div style="max-width: 900px; margin: 0 auto; padding: 40px 20px;">
                <div class="backup-container">
                    <h2 style="font-size: 24px; font-weight: 700; color: #1a1a1a; margin-bottom: 10px;">Backup & Restore
                    </h2>
                    <p style="font-size: 15px; color: #666; margin-bottom: 30px; line-height: 1.5;">Protect your data by
                        exporting a complete snapshot of your planner to a JSON file. You can restore your data anytime
                        using the import feature.</p>

                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <!-- Export Section -->
                        <div
                            style="flex: 1; min-width: 300px; padding: 20px; border: 1px solid #ddd; border-radius: 12px; background-color: #f9f9f9;">
                            <h3 style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 10px;">Export Data
                            </h3>
                            <p style="font-size: 13px; color: #777; margin-bottom: 20px;">Download your current data as
                                a
                                JSON file. This includes all tasks, tracker items, and settings.</p>
                            <button id="exportJsonBtn"
                                style="font-family: inherit; font-size: 14px; font-weight: 600; padding: 10px 20px; background-color: #333; color: white; border: none; border-radius: 6px; cursor: pointer;">Export
                                to JSON</button>
                        </div>

                        <!-- Import Section -->
                        <div
                            style="flex: 1; min-width: 300px; padding: 20px; border: 1px solid #ddd; border-radius: 12px; background-color: #f9f9f9;">
                            <h3 style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 10px;">Import Data
                            </h3>
                            <p style="font-size: 13px; color: #777; margin-bottom: 20px;">Restore your data from a JSON
                                backup file. This will <strong>overwrite</strong> all current data.</p>
                            <button id="importJsonBtn"
                                style="font-family: inherit; font-size: 14px; font-weight: 600; padding: 10px 20px; background-color: #e67e22; color: white; border: none; border-radius: 6px; cursor: pointer;">Import
                                from JSON</button>
                            <input type="file" id="importFile" accept=".json" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <footer class="main-footer">
        <div class="footer-left">
            <h1 class="footer-title" data-tooltip="Version 2.5">Course Planner</h1>
        </div>
        <div class="footer-actions">
            <!-- Tracker Group -->
            <button id="lessonTrackerBtn">Lesson Tracker</button>
            <button id="assignmentTrackerBtn">Assignment Tracker</button>
            <div class="footer-divider"></div>

            <!-- Tool Group -->
            <button id="canvas-import-btn">
                <svg viewBox="0 0 1920 1920" xmlns="http://www.w3.org/2000/svg">
                    <g id="SVGRepo_iconCarrier">
                        <path
                            d="M958.568 277.97C1100.42 277.97 1216.48 171.94 1233.67 34.3881 1146.27 12.8955 1054.57 0 958.568 0 864.001 0 770.867 12.8955 683.464 34.3881 700.658 171.94 816.718 277.97 958.568 277.97ZM35.8207 682.031C173.373 699.225 279.403 815.285 279.403 957.136 279.403 1098.99 173.373 1215.05 35.8207 1232.24 12.8953 1144.84 1.43262 1051.7 1.43262 957.136 1.43262 862.569 12.8953 769.434 35.8207 682.031ZM528.713 957.142C528.713 1005.41 489.581 1044.55 441.31 1044.55 393.038 1044.55 353.907 1005.41 353.907 957.142 353.907 908.871 393.038 869.74 441.31 869.74 489.581 869.74 528.713 908.871 528.713 957.142ZM1642.03 957.136C1642.03 1098.99 1748.06 1215.05 1885.61 1232.24 1908.54 1144.84 1920 1051.7 1920 957.136 1920 862.569 1908.54 769.434 1885.61 682.031 1748.06 699.225 1642.03 815.285 1642.03 957.136ZM1567.51 957.142C1567.51 1005.41 1528.38 1044.55 1480.11 1044.55 1431.84 1044.55 1392.71 1005.41 1392.71 957.142 1392.71 908.871 1431.84 869.74 1480.11 869.74 1528.38 869.74 1567.51 908.871 1567.51 957.142ZM958.568 1640.6C816.718 1640.6 700.658 1746.63 683.464 1884.18 770.867 1907.11 864.001 1918.57 958.568 1918.57 1053.14 1918.57 1146.27 1907.11 1233.67 1884.18 1216.48 1746.63 1100.42 1640.6 958.568 1640.6ZM1045.98 1480.11C1045.98 1528.38 1006.85 1567.51 958.575 1567.51 910.304 1567.51 871.172 1528.38 871.172 1480.11 871.172 1431.84 910.304 1392.71 958.575 1392.71 1006.85 1392.71 1045.98 1431.84 1045.98 1480.11ZM1045.98 439.877C1045.98 488.148 1006.85 527.28 958.575 527.28 910.304 527.28 871.172 488.148 871.172 439.877 871.172 391.606 910.304 352.474 958.575 352.474 1006.85 352.474 1045.98 391.606 1045.98 439.877ZM1441.44 1439.99C1341.15 1540.29 1333.98 1697.91 1418.52 1806.8 1579 1712.23 1713.68 1577.55 1806.82 1418.5 1699.35 1332.53 1541.74 1339.7 1441.44 1439.99ZM1414.21 1325.37C1414.21 1373.64 1375.08 1412.77 1326.8 1412.77 1278.53 1412.77 1239.4 1373.64 1239.4 1325.37 1239.4 1277.1 1278.53 1237.97 1326.8 1237.97 1375.08 1237.97 1414.21 1277.1 1414.21 1325.37ZM478.577 477.145C578.875 376.846 586.039 219.234 501.502 110.339 341.024 204.906 206.338 339.592 113.203 498.637 220.666 584.607 378.278 576.01 478.577 477.145ZM679.155 590.32C679.155 638.591 640.024 677.723 591.752 677.723 543.481 677.723 504.349 638.591 504.349 590.32 504.349 542.048 543.481 502.917 591.752 502.917 640.024 502.917 679.155 542.048 679.155 590.32ZM1440 475.712C1540.3 576.01 1697.91 583.174 1806.8 498.637 1712.24 338.159 1577.55 203.473 1418.51 110.339 1332.54 217.801 1341.13 375.413 1440 475.712ZM1414.21 590.32C1414.21 638.591 1375.08 677.723 1326.8 677.723 1278.53 677.723 1239.4 638.591 1239.4 590.32 1239.4 542.048 1278.53 502.917 1326.8 502.917 1375.08 502.917 1414.21 542.048 1414.21 590.32ZM477.145 1438.58C376.846 1338.28 219.234 1331.12 110.339 1415.65 204.906 1576.13 339.593 1710.82 498.637 1805.39 584.607 1696.49 577.443 1538.88 477.145 1438.58ZM679.155 1325.37C679.155 1373.64 640.024 1412.77 591.752 1412.77 543.481 1412.77 504.349 1373.64 504.349 1325.37 504.349 1277.1 543.481 1237.97 591.752 1237.97 640.024 1237.97 679.155 1277.1 679.155 1325.37Z" />
                    </g>
                </svg>
                Canvas
            </button>
            <button id="backupBtn">Backup</button>
            <div class="footer-divider"></div>

            <!-- Action Group -->
            <button id="resetBtn">Reset</button>
            <button id="saveBtn">Save</button>
        </div>
    </footer>

    <div id="trackerContextMenu" class="context-menu" style="display: none;">
        <div class="context-menu-item" id="pauseUnpauseBtn"></div>
    </div>

    <div id="dayCardContextMenu" class="context-menu" style="display: none;">
        <div class="context-menu-item link-action" id="addEditLinkBtn">Add / Edit Link</div>
        <div class="context-menu-item link-action" id="removeLinkBtn" style="display: none;">Remove Link</div>
    </div>

    <div id="linkModal" class="link-modal-overlay">
        <div class="link-modal">
            <h2>Add / Edit Link</h2>
            <div class="course-name" id="linkModalCourseName"></div>
            <input type="text" id="linkModalInput" class="link-modal-input" placeholder="Paste your link here..."
                spellcheck="false">
            <div class="link-modal-buttons">
                <button class="btn-cancel" id="linkModalCancel">Cancel</button>
                <button class="btn-save" id="linkModalSave">Save Link</button>
            </div>
        </div>
    </div>

    <!-- Assignment Context Menu (for Assignment Tracker only) -->
    <div id="assignmentContextMenu" class="context-menu" style="display: none;">
        <div class="context-menu-item split-action" id="splitAssignmentBtn">Split Assignment</div>
        <div class="context-menu-item complete-action" id="completeNowBtn">Complete Now</div>
        <div class="context-menu-item reset-action" id="resetSplitBtn" style="display: none;">Reset Split</div>
    </div>

    <!-- Lesson Context Menu (for Lesson Tracker only) -->
    <div id="lessonContextMenu" class="context-menu" style="display: none;">
        <div class="context-menu-item link-action" id="addLinksToLessonBtn">Add Links to Lesson Name</div>
    </div>

    <!-- Split Assignment Modal -->
    <div id="splitModal" class="split-modal-overlay">
        <div class="split-modal">
            <h2>Split Assignment</h2>
            <div class="assignment-info" id="splitModalAssignmentInfo"></div>
            <label for="splitModalInput">How many parts do you want to split this assignment into?</label>
            <input type="number" id="splitModalInput" class="split-modal-input" min="2" max="30" value="2"
                placeholder="Enter number of parts">
            <div class="split-modal-buttons">
                <button class="btn-cancel" id="splitModalCancel">Cancel</button>
                <button class="btn-split" id="splitModalSave">Split</button>
            </div>
        </div>
    </div>

    <!-- Lesson Links Modal -->
    <div id="lessonLinksModal" class="link-modal-overlay">
        <div class="link-modal">
            <h2>Add Links to Lesson Name</h2>
            <div class="lesson-info" id="lessonLinksModalInfo"></div>
            <input type="text" id="lessonLinksModalInput" class="link-modal-input"
                placeholder="Paste links here (separate multiple links with commas)..." spellcheck="false">
            <div class="link-modal-buttons">
                <button class="btn-cancel" id="lessonLinksModalCancel">Cancel</button>
                <button class="btn-save" id="lessonLinksModalSave">Save Links</button>
            </div>
        </div>
    </div>

    <!-- Add Lessons Modal -->
    <div id="addLessonModal" class="link-modal-overlay">
        <div class="link-modal">
            <h2>Add Lessons</h2>
            <p style="font-size: 14px; color: #767676; margin-bottom: 15px;">Select a course and paste lesson names
                below, one per line.</p>
            <select id="bulkLessonCourse" class="add-items-modal-select" required></select>
            <textarea id="bulkLessonNames" class="add-items-modal-textarea"
                placeholder="Paste lesson names here, one per line..." required></textarea>
            <div class="link-modal-buttons">
                <button class="btn-cancel" id="addLessonModalCancel">Cancel</button>
                <button class="btn-save" id="addLessonBtn">Add Lessons</button>
            </div>
        </div>
    </div>

    <!-- Add Assignments Modal -->
    <div id="addAssignmentModal" class="link-modal-overlay">
        <div class="link-modal">
            <h2>Add Assignments</h2>
            <p style="font-size: 14px; color: #767676; margin-bottom: 15px;">Select a course and paste assignment names
                below, one per line.</p>
            <select id="bulkAssignmentCourse" class="add-items-modal-select" required></select>
            <textarea id="bulkAssignmentNames" class="add-items-modal-textarea"
                placeholder="Paste assignment names here, one per line..." required></textarea>
            <div class="link-modal-buttons">
                <button class="btn-cancel" id="addAssignmentModalCancel">Cancel</button>
                <button class="btn-save" id="addAssignmentBtn">Add Assignments</button>
            </div>
        </div>
    </div>

    <!-- Canvas Import Modal -->
    <div id="canvasImportModal" class="link-modal-overlay">
        <div class="link-modal" style="max-width: 600px; width: 90%;">
            <h2>Import from Canvas</h2>

            <!-- Step 1: Paste Text -->
            <div id="canvas-step-1">
                <p style="font-size: 14px; color: #767676; margin-bottom: 15px;">
                    Go to your Canvas "Modules" page, press <strong>Ctrl+A</strong> then <strong>Ctrl+C</strong> to copy
                    everything,
                    and paste it below.
                </p>
                <textarea id="canvas-raw-text" class="add-items-modal-textarea" placeholder="Paste Canvas data here..."
                    style="min-height: 200px; max-height: 500px; overflow-y: auto;"></textarea>
                <div class="link-modal-buttons">
                    <button class="btn-cancel" id="canvas-cancel-btn">Cancel</button>
                    <button class="btn-save" id="canvas-preview-btn">Preview</button>
                </div>
            </div>

            <!-- Step 2: Preview & Import -->
            <div id="canvas-step-2" style="display: none;">
                <h4>Preview Import</h4>
                <p>Review the identified items below.</p>



                <div id="canvas-preview-container"></div>

                <div style="margin-top: 15px;">
                    <label for="canvas-import-course" style="font-size: 14px; font-weight: 600;">Import into
                        Course:</label>
                    <select id="canvas-import-course" class="add-items-modal-select" style="margin-top: 5px;"></select>
                </div>

                <div class="link-modal-buttons">
                    <button class="btn-cancel" id="canvas-back-btn">Back</button>
                    <button class="btn-save" id="canvas-import-action-btn">Import</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // II. Data Persistence & Structure
            const LS_LESSONS_KEY = 'tracker_lessons';
            const LS_ASSIGNMENTS_KEY = 'tracker_assignments';
            const LS_PAUSED_COURSES_KEY = 'tracker_paused_courses'; // NEW KEY
            const LS_COURSE_CUSTOM_LINKS_KEY = 'course_custom_links'; // NEW: Custom link storage
            const LS_LINK_PREVIEW_TOGGLE_KEY = 'link_preview_toggle'; // NEW: Track which preview is shown
            const LS_SPLIT_ASSIGNMENTS_KEY = 'split_assignments'; // NEW: Split assignments progress data
            const LS_LESSON_LINKS_KEY = 'lesson_links'; // NEW: Lesson links storage
            const ALL_COURSE_NAMES = [
                "Advanced Functions", "Data Management", "English", "Economics", "Media Arts",
                "Business Leadership", "Challenge & Change", "Ontario Literacy Course"
            ];

            // Define colors for JavaScript use
            const COLOR_DEFAULT_GRAY = '#767676';
            const COLOR_INPUT_TEXT = '#333';

            const mainContent = document.getElementById('mainContent');
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabContents = document.querySelectorAll('.tab-content');
            const TAB_PREFIX = 'day';

            // **NEW:** State to track unsaved changes
            let hasUnsavedChanges = false;

            // **NEW FUNCTIONS:** Custom Link Management
            function getCustomLinks() {
                const raw = localStorage.getItem(LS_COURSE_CUSTOM_LINKS_KEY);
                return raw ? JSON.parse(raw) : {};
            }

            function setCustomLink(courseName, url) {
                const links = getCustomLinks();
                links[courseName] = url;
                localStorage.setItem(LS_COURSE_CUSTOM_LINKS_KEY, JSON.stringify(links));
            }

            function getCustomLink(courseName) {
                const links = getCustomLinks();
                return links[courseName] || null;
            }

            function deleteCustomLink(courseName) {
                const links = getCustomLinks();
                delete links[courseName];
                localStorage.setItem(LS_COURSE_CUSTOM_LINKS_KEY, JSON.stringify(links));
            }

            function hasCustomLink(courseName) {
                return getCustomLink(courseName) !== null;
            }

            // **NEW FUNCTIONS:** Split Assignment Management
            // Key format: "courseName::assignmentName" to uniquely identify assignments
            function getSplitAssignments() {
                const raw = localStorage.getItem(LS_SPLIT_ASSIGNMENTS_KEY);
                return raw ? JSON.parse(raw) : {};
            }

            function getSplitAssignmentKey(courseName, assignmentName) {
                return `${courseName}::${assignmentName}`;
            }

            function getSplitAssignment(courseName, assignmentName) {
                const key = getSplitAssignmentKey(courseName, assignmentName);
                const splits = getSplitAssignments();
                return splits[key] || null;
            }

            function setSplitAssignment(courseName, assignmentName, totalDays, completedDays) {
                const key = getSplitAssignmentKey(courseName, assignmentName);
                const splits = getSplitAssignments();
                splits[key] = {
                    totalDays: totalDays,
                    completedDays: completedDays,
                    courseName: courseName,
                    assignmentName: assignmentName
                };
                localStorage.setItem(LS_SPLIT_ASSIGNMENTS_KEY, JSON.stringify(splits));
            }

            function deleteSplitAssignment(courseName, assignmentName) {
                const key = getSplitAssignmentKey(courseName, assignmentName);
                const splits = getSplitAssignments();
                delete splits[key];
                localStorage.setItem(LS_SPLIT_ASSIGNMENTS_KEY, JSON.stringify(splits));
            }

            function isSplitAssignment(courseName, assignmentName) {
                return getSplitAssignment(courseName, assignmentName) !== null;
            }

            // --- **NEW FUNCTION:** Advance split assignment progress
            function advanceSplitAssignmentProgress(courseName, assignmentName) {
                const split = getSplitAssignment(courseName, assignmentName);
                if (!split) return null;

                // Ensure numbers
                const total = Number(split.totalDays);
                const current = Number(split.completedDays);

                const newCompleted = Math.min(current + 1, total);
                setSplitAssignment(courseName, assignmentName, total, newCompleted);

                return {
                    totalDays: total,
                    completedDays: newCompleted,
                    isComplete: newCompleted >= total
                };
            }

            function completeSplitAssignmentNow(courseName, assignmentName) {
                const split = getSplitAssignment(courseName, assignmentName);
                if (!split) return null;

                setSplitAssignment(courseName, assignmentName, split.totalDays, split.totalDays);

                return {
                    totalDays: split.totalDays,
                    completedDays: split.totalDays,
                    isComplete: true
                };
            }

            function resetSplitAssignmentProgress(courseName, assignmentName) {
                const split = getSplitAssignment(courseName, assignmentName);
                if (!split) return null;

                setSplitAssignment(courseName, assignmentName, split.totalDays, 0);

                return {
                    totalDays: split.totalDays,
                    completedDays: 0,
                    isComplete: false
                };
            }

            // **NEW FUNCTIONS:** Lesson Links Management
            // Key format: "courseName::lessonName" to uniquely identify lessons
            function getLessonLinks() {
                const raw = localStorage.getItem(LS_LESSON_LINKS_KEY);
                return raw ? JSON.parse(raw) : {};
            }

            function getLessonLinkKey(courseName, lessonName) {
                return `${courseName}::${lessonName}`;
            }

            function getLessonLink(courseName, lessonName) {
                const key = getLessonLinkKey(courseName, lessonName);
                const links = getLessonLinks();
                return links[key] || null;
            }

            function setLessonLink(courseName, lessonName, linksString) {
                const key = getLessonLinkKey(courseName, lessonName);
                const links = getLessonLinks();
                links[key] = linksString;
                localStorage.setItem(LS_LESSON_LINKS_KEY, JSON.stringify(links));
            }

            function deleteLessonLink(courseName, lessonName) {
                const key = getLessonLinkKey(courseName, lessonName);
                const links = getLessonLinks();
                delete links[key];
                localStorage.setItem(LS_LESSON_LINKS_KEY, JSON.stringify(links));
            }

            function hasLessonLink(courseName, lessonName) {
                return getLessonLink(courseName, lessonName) !== null;
            }

            // **NEW:** Update href attribute on course title h3
            function updateCourseH3Href(courseName) {
                document.querySelectorAll('.course-card, .tracker-course-card').forEach(card => {
                    if (card.getAttribute('data-course-name') === courseName) {
                        const h3 = card.querySelector('h3');
                        if (h3) {
                            let linkEl = h3.querySelector('a.course-link');
                            const customLink = getCustomLink(courseName);

                            if (customLink && !linkEl) {
                                // Create anchor tag and wrap the content
                                linkEl = document.createElement('a');
                                linkEl.className = 'course-link';
                                linkEl.href = customLink;
                                linkEl.textContent = h3.textContent;
                                h3.textContent = '';
                                h3.appendChild(linkEl);
                            } else if (customLink && linkEl) {
                                // Update existing anchor href
                                linkEl.href = customLink;
                            } else if (!customLink && linkEl) {
                                // Remove anchor if link was deleted
                                const text = linkEl.textContent;
                                h3.textContent = text;
                            }
                        }
                    }
                });
            }

            // --- II. Initialization (MODIFIED to remove sample data) ---
            function initializeTrackerData() {
                // Initialize both tracker keys to an empty array if they do not exist
                if (!localStorage.getItem(LS_LESSONS_KEY)) {
                    localStorage.setItem(LS_LESSONS_KEY, JSON.stringify([]));
                }

                if (!localStorage.getItem(LS_ASSIGNMENTS_KEY)) {
                    localStorage.setItem(LS_ASSIGNMENTS_KEY, JSON.stringify([]));
                }

                // NEW: Initialize Paused Courses
                if (!localStorage.getItem(LS_PAUSED_COURSES_KEY)) {
                    localStorage.setItem(LS_PAUSED_COURSES_KEY, JSON.stringify({ lesson: [], assignment: [] }));
                }
            }

            // --- Helper to manage paused courses data ---
            function getPausedCourses() {
                // Ensure default structure exists before returning
                const raw = localStorage.getItem(LS_PAUSED_COURSES_KEY);
                let paused = JSON.parse(raw) || { lesson: [], assignment: [] };
                if (!paused.lesson) paused.lesson = [];
                if (!paused.assignment) paused.assignment = [];
                return paused;
            }

            // --- Toggle Pause State (MODIFIED for cross-tracker synchronization) ---
            function toggleCoursePauseState(courseName, type) {
                let pausedCourses = getPausedCourses();

                // Determine if the course is currently paused in the * initial* tracker
                const isCurrentlyPaused = (pausedCourses[type] || []).includes(courseName);

                // Determine the new state (toggle)
                const shouldPause = !isCurrentlyPaused;

                // Function to set the pause state for a specific type
                const setPauseState = (typeKey, pauseState) => {
                    const list = pausedCourses[typeKey] || [];
                    const index = list.indexOf(courseName);

                    if (pauseState && index === -1) {
                        // Pause: Add course to the list
                        list.push(courseName);
                    } else if (!pauseState && index > -1) {
                        // Unpause: Remove course from the list
                        list.splice(index, 1);
                    }
                    pausedCourses[typeKey] = list;
                };

                // Apply the new state to BOTH trackers for synchronization
                setPauseState('lesson', shouldPause);
                setPauseState('assignment', shouldPause);

                localStorage.setItem(LS_PAUSED_COURSES_KEY, JSON.stringify(pausedCourses));

                // Re-render *all* affected components

                // 1. Render the Lesson Tracker if visible/needed
                const activeTabId = document.querySelector('.tab-content.active')?.id;
                if (activeTabId === 'lessonTracker') {
                    renderTracker('lesson');
                } else if (activeTabId === 'assignmentTracker') {
                    renderTracker('assignment');
                }

                // 2. Update all Day A/B cards (MUST run for visual feedback)
                updateDayCardPauseState(courseName, shouldPause);

                // 3. Update overall progress (since totals change)
                calculateAndRenderOverallProgress('lesson');
                calculateAndRenderOverallProgress('assignment');
            }

            // **NEW FUNCTION:** Update Day Card Visuals
            function updateDayCardPauseState(courseName, isPaused) {
                document.querySelectorAll('.course-card[data-course-name]').forEach(card => {
                    if (card.getAttribute('data-course-name') === courseName) {
                        card.classList.toggle('paused', isPaused);
                        // Rerun applyThemeColor to update inline styles if needed
                        card.querySelectorAll('.task-list textarea, .task-link').forEach(field => {
                            applyThemeColor(field);
                        });
                    }
                });

                // **NEW:** Reorder cards in both Day A and Day B to push paused cards to the back
                reorderDayCards('dayA');
                reorderDayCards('dayB');
            }

            // --- YouTube Detection Logic (UNCHANGED) ---
            function getYouTubeEmbed(url) {
                const reg = /(?:youtube\.com\/(?:watch\?v=|v\/|embed\/)|youtu\.be\/)([A-Za-z0-9_-]+)/;
                const match = url.match(reg);
                if (match) {
                    const videoId = match[1];
                    const origin = window.location.origin;
                    return `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&origin=${origin}`;
                }
                return null;
            }

            // --- Embed/Link Rendering Logic (MODIFIED for comma-separated links) ---
            function renderEmbed(courseCardElement, rawLinksString) {
                const embedContainer = courseCardElement.querySelector('.course-embed-container');
                embedContainer.innerHTML = '';

                // 1. Split the raw string by comma, trim whitespace, and filter out empty strings
                const links = (rawLinksString || '').split(',').map(link => link.trim()).filter(link => link !== '');

                if (links.length === 0) {
                    embedContainer.style.display = 'none';
                    return;
                }

                let allEmbedsHTML = '';

                links.forEach(link => {
                    const embedUrl = getYouTubeEmbed(link);

                    if (embedUrl) {
                        // This is a YouTube video
                        allEmbedsHTML += `
                            <div class="video-embed-wrapper" style="margin-bottom: 15px;">
                                <iframe 
                                    src="${embedUrl}" 
                                    title="YouTube video player"
                                    frameborder="0"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                    referrerpolicy="strict-origin-when-cross-origin" 
                                    allowfullscreen>
                                </iframe>
                            </div>
                        `;
                    } else {
                        // This is a regular link
                        const displayUrl = link.startsWith('http') ? link : `http://${link}`;
                        allEmbedsHTML += `<a href="${displayUrl}" target="_blank" rel="noopener noreferrer">${link}</a>`;
                    }
                });

                embedContainer.innerHTML = allEmbedsHTML;
                embedContainer.style.display = 'block';
            }

            // --- Centralized function to manage all day-switching logic (UPDATED for Green Theme and Progress Bar) ---
            function switchDay(dayId) {
                // 1. Update localStorage for user preference
                const dayLetter = dayId.startsWith(TAB_PREFIX) ? dayId.slice(-1) : null;
                if (dayLetter) localStorage.setItem('selectedDay', dayLetter);

                // 2. Update Tab Classes and Content Visibility
                // NOTE: tabLinks now only includes Day A and Day B
                tabLinks.forEach(item => {
                    const isActive = item.getAttribute('data-tab') === dayId;
                    item.classList.toggle('active', isActive);
                });
                tabContents.forEach(item => {
                    const isActive = item.id === dayId;
                    item.classList.toggle('active', isActive);
                });

                // 3. Update Body Class for CSS Variables
                document.body.classList.remove('day-a', 'day-b', 'tracker-green');
                if (dayId === 'dayA') {
                    document.body.classList.add('day-a');
                } else if (dayId === 'dayB') {
                    document.body.classList.add('day-b');
                } else if (dayId === 'lessonTracker' || dayId === 'assignmentTracker') {
                    document.body.classList.add('tracker-green');
                } else if (dayId === 'backupTab') {
                    // Backup tab uses white background, no special theme class needed for now
                    // but we ensure tracker-green is removed
                }

                // 4. Handle Tracker Tabs and render progress
                if (dayId === 'lessonTracker') {
                    renderTracker('lesson');
                    calculateAndRenderOverallProgress('lesson'); // NEW: Render progress
                } else if (dayId === 'assignmentTracker') {
                    renderTracker('assignment');
                    calculateAndRenderOverallProgress('assignment'); // NEW: Render progress
                }

                // 5. Resize Textareas (must run after visibility is set)
                if (dayId.startsWith(TAB_PREFIX)) resizeFieldsForActiveDay(dayId); // Renamed function

                // **NEW:** Update autofill button visibility when switching tabs
                updateAutofillButtonVisibility();
            }

            // --- **NEW:** Reorder Day Cards to Push Paused Cards to the Back ---
            function reorderDayCards(dayId) {
                const dayContainer = document.getElementById(dayId);
                const courseGrid = dayContainer.querySelector('.course-grid');
                if (!courseGrid) return;

                const cards = Array.from(courseGrid.querySelectorAll('.course-card'));

                // Separate unpaused and paused cards, maintaining alphabetical order within each group
                const unpausedCards = cards.filter(card => !card.classList.contains('paused'));
                const pausedCards = cards.filter(card => card.classList.contains('paused'));

                // Sort both groups alphabetically by course name
                const sortByCourseName = (a, b) => {
                    const nameA = a.getAttribute('data-course-name') || a.querySelector('h3').textContent.trim();
                    const nameB = b.getAttribute('data-course-name') || b.querySelector('h3').textContent.trim();
                    return nameA.localeCompare(nameB);
                };

                unpausedCards.sort(sortByCourseName);
                pausedCards.sort(sortByCourseName);

                // Clear the grid and re-append in the new order (unpaused first, then paused)
                courseGrid.innerHTML = '';
                [...unpausedCards, ...pausedCards].forEach(card => {
                    courseGrid.appendChild(card);
                });
            }

            // --- Auto-select Day logic (MODIFIED to handle tracker tabs) ---
            function autoSelectDay() {
                const dayMap = { 0: 'A', 1: 'B', 2: 'A', 3: 'B', 4: 'A', 5: 'A', 6: 'A' };
                const today = new Date();
                const weekday = today.getDay();
                const desiredDay = dayMap[weekday] || 'A';
                const savedDay = localStorage.getItem('selectedDay');
                const initialDay = savedDay || desiredDay;

                switchDay(TAB_PREFIX + initialDay);

                // **NEW:** Update autofill button visibility after initial selection
                updateAutofillButtonVisibility();
            }

            // --- Textarea Resize Function (UPDATED for fix) ---
            function resizeFieldsForActiveDay(dayId) {
                const dayContainer = document.getElementById(dayId);
                // Select task-notes and the new task-name textareas
                dayContainer.querySelectorAll('.task-notes, .task-name').forEach(field => {
                    field.style.height = '0'; // FIX: Reset height to 0 before calculating scrollHeight
                    if (field.value.trim() !== '') {
                        field.style.height = field.scrollHeight + 'px';
                    } else {
                        field.style.height = '38px'; // Set back to min-height if empty
                    }
                });
            }

            // **NEW:** Resize all textareas in both days (called on initialization)
            function resizeAllDayFields() {
                resizeFieldsForActiveDay('dayA');
                resizeFieldsForActiveDay('dayB');
            }

            // **NEW FUNCTION:** Logic to check if a day card is fully completed
            function updateCardCompletionState(courseCard) {
                const lessonNameField = courseCard.querySelector('.task-lesson-name');
                const lessonCheckbox = courseCard.querySelector('.task-lesson-checkbox');
                const deleteButton = courseCard.querySelector('.delete-course-card-btn');

                // 1. Determine Existence
                const hasLesson = lessonNameField && lessonNameField.value.trim() !== '';

                // Check for ANY assignments
                const assignmentRows = courseCard.querySelectorAll('.task-assignment-main');
                const hasAnyAssignment = Array.from(assignmentRows).some(row => {
                    const name = row.querySelector('.task-assignment-name');
                    return name && name.value.trim() !== '';
                });

                // If nothing exists, hide button immediately
                if (!hasLesson && !hasAnyAssignment) {
                    deleteButton.classList.remove('completed');
                    return;
                }

                // 2. Determine Interaction (Satisfied) Status
                let lessonSatisfied = true;
                if (hasLesson) {
                    lessonSatisfied = lessonCheckbox && lessonCheckbox.checked;
                }

                let allAssignmentsSatisfied = true;
                if (hasAnyAssignment) {
                    assignmentRows.forEach(row => {
                        const name = row.querySelector('.task-assignment-name');
                        const cb = row.querySelector('.task-assignment-checkbox');
                        if (name && name.value.trim() !== '') {
                            if (!cb || !cb.checked) {
                                allAssignmentsSatisfied = false;
                            }
                        }
                    });
                }

                // 3. Final Evaluation
                const isCardCompleted = lessonSatisfied && allAssignmentsSatisfied;

                deleteButton.classList.toggle('completed', isCardCompleted);
            }

            // **NEW FUNCTION:** Update split assignment progress visualization on Day A/B cards
            function updateDayCardSplitProgress(courseCard, courseName, assignmentName, splitDataOverride = null) {
                const assignmentCheckboxDiv = courseCard.querySelector('.task-assignment-main');
                if (!assignmentCheckboxDiv) return;

                const wrapper = assignmentCheckboxDiv.querySelector('.progress-circle-wrapper');
                const checkbox = assignmentCheckboxDiv.querySelector('.task-assignment-checkbox');

                // Use override if provided, otherwise fetch from storage
                const splitData = splitDataOverride || getSplitAssignment(courseName, assignmentName);

                // Case 1: Revert to normal checkbox if no split data exists but wrapper does
                if (!splitData) {
                    if (wrapper && checkbox) {
                        wrapper.remove();
                        checkbox.style.display = ''; // Show checkbox
                        checkbox.checked = false; // Reset state
                    }
                    return;
                }

                const totalDays = Number(splitData.totalDays);
                const completedDays = Number(splitData.completedDays);
                const isComplete = completedDays >= totalDays;
                const progress = totalDays > 0 ? completedDays / totalDays : 0;

                // Determine the day color (Use data-day attribute for reliability)
                const dayId = courseCard.getAttribute('data-day') || courseCard.closest('.tab-content')?.id || 'dayA';

                let strokeColorClass = 'in-progress';
                if (isComplete) {
                    strokeColorClass = dayId === 'dayA' ? 'completed-day-a' : 'completed-day-b';
                }

                // Reuse variables defined above or re-select
                let existingWrapper = assignmentCheckboxDiv.querySelector('.progress-circle-wrapper');

                if (!existingWrapper && checkbox) {
                    // Replace checkbox with progress circle
                    const radius = 11.5;
                    const circumference = 2 * Math.PI * radius;
                    const strokeDashoffset = circumference * (1 - progress);

                    const wrapper = document.createElement('div');
                    const wrapperClass = isComplete ?
                        ('completed ' + (dayId === 'dayA' ? 'completed-day-a' : 'completed-day-b')) : '';
                    wrapper.className = `progress-circle-wrapper ${wrapperClass}`;
                    wrapper.setAttribute('data-course', courseName);
                    wrapper.setAttribute('data-assignment', assignmentName);
                    wrapper.innerHTML = `
                        <svg class="progress-circle-svg" viewBox="0 0 25 25">
                            <circle class="progress-circle-bg" cx="12.5" cy="12.5" r="${radius}"></circle>
                            <circle class="progress-circle-progress ${strokeColorClass}" 
                                    cx="12.5" cy="12.5" r="${radius}"
                                    stroke-dasharray="${circumference}"
                                    stroke-dashoffset="${strokeDashoffset}">
                            </circle>
                        </svg>
                        <div class="progress-circle-checkmark"></div>
                    `;

                    checkbox.style.display = 'none';
                    checkbox.parentNode.insertBefore(wrapper, checkbox);

                    // Re-select newly created wrapper for subsequent updates (e.g. checkmark)
                    existingWrapper = wrapper;

                } else if (existingWrapper) {
                    // Update existing progress circle
                    const radius = 11.5;
                    const circumference = 2 * Math.PI * radius;
                    const strokeDashoffset = circumference * (1 - progress);

                    const progressCircle = existingWrapper.querySelector('.progress-circle-progress');
                    if (progressCircle) {
                        progressCircle.setAttribute('stroke-dashoffset', strokeDashoffset);
                        // Explicitly overwrite class to remove previous states
                        progressCircle.className = `progress-circle-progress ${strokeColorClass}`;

                        // **FIX:** Force inline style update to ensure immediate repaint with correct color
                        if (isComplete) {
                            progressCircle.style.stroke = dayId === 'dayA' ? 'var(--color-day-a)' : 'var(--color-day-b)';
                        } else {
                            progressCircle.style.stroke = ''; // Remove inline style to fall back to CSS class
                        }
                    }

                    // Update wrapper completion class
                    existingWrapper.classList.remove('completed', 'completed-day-a', 'completed-day-b');
                    if (isComplete) {
                        existingWrapper.classList.add('completed', dayId === 'dayA' ? 'completed-day-a' : 'completed-day-b');
                    }
                }

                // Update checkmark opacity (run for both new and existing wrappers)
                if (existingWrapper) {
                    const checkmark = existingWrapper.querySelector('.progress-circle-checkmark');
                    if (checkmark) {
                        if (isComplete) {
                            checkmark.style.opacity = '1';
                        } else if (completedDays >= 1) {
                            checkmark.style.opacity = '0.5';
                        } else {
                            checkmark.style.opacity = '0';
                        }
                    }
                }

                // Update the hidden checkbox state
                if (checkbox) {
                    // **MODIFIED:** Do not force checkbox.checked = isComplete.
                    // We now manage this manually in interaction listeners to track "interaction" vs "completion".
                    // However, if it IS complete, we should ensure it matches to avoid state desync.
                    if (isComplete) {
                        checkbox.checked = true;
                    }
                    // Crucially: If NOT complete, we leave it alone (could be true if interacted, or false if not).
                }
            }

            // --- 2. Tab Switching Logic (MODIFIED for new tabs) ---
            // This now only handles Day A and Day B tabs in the header
            tabLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const dayId = link.getAttribute('data-tab');
                    switchDay(dayId);
                });
            });

            // --- Function to update tracker item status from Card Checkbox (NEW FUNCTION) ---
            function updateTrackerItemStatusFromCard(course, type, name, isChecked, isIndented = false, isOutdented = false, itemType = 'assignment') {
                const storageKey = type === 'lesson' ? LS_LESSONS_KEY : LS_ASSIGNMENTS_KEY;
                let data = JSON.parse(localStorage.getItem(storageKey)) || [];
                const newStatus = isChecked ? 'Finished' : 'Not Started';

                let itemFound = false;

                data = data.map(item => {
                    // Check for item existence by matching course and name
                    if (item.course === course && item.name === name) {
                        item.status = newStatus;
                        // **NEW:** Persist indentation and type state
                        if (type !== 'lesson') {
                            item.isIndented = isIndented;
                            item.isOutdented = isOutdented;
                            item.type = itemType;
                        }
                        itemFound = true;
                    }
                    return item;
                });

                // If the item wasn't found (e.g., a new lesson/assignment was typed in), 
                // we should add it to the tracker data before setting the status.
                if (!itemFound && name.trim() !== '') {
                    const newItem = {
                        id: Date.now() + Math.random(),
                        name: name,
                        course: course,
                        status: newStatus,
                        isIndented: isIndented,
                        isOutdented: isOutdented,
                        type: itemType
                    };
                    data.push(newItem);
                }

                localStorage.setItem(storageKey, JSON.stringify(data));

                // Re-render the active tracker tab if it's visible
                const activeTabId = document.querySelector('.tab-content.active')?.id;
                if (activeTabId === 'lessonTracker' && type === 'lesson') {
                    renderTracker('lesson');
                } else if (activeTabId === 'assignmentTracker' && type === 'assignment') {
                    renderTracker('assignment');
                }
            }

            // **NEW FUNCTION:** Sync tracker changes (e.g. from context menu) to Day Cards
            function syncTrackerInputToDayCards(courseName, type, taskName, isChecked) {
                // Find cards in Day A and Day B
                const cards = document.querySelectorAll(`.course-card[data-course-name="${courseName}"]`);

                cards.forEach(card => {
                    let checkbox;
                    let nameField;

                    if (type === 'lesson') {
                        checkbox = card.querySelector('.task-lesson-checkbox');
                        nameField = card.querySelector('.task-lesson-name');
                    } else {
                        checkbox = card.querySelector('.task-assignment-checkbox');
                        nameField = card.querySelector('.task-assignment-name');
                    }

                    // Only update if the name matches (to ensure we are targeting the right task)
                    if (nameField && nameField.value.trim() === taskName) {
                        if (checkbox) {
                            checkbox.checked = isChecked;
                        }

                        // If it is a split assignment, we also need to update the visual progress
                        if (type === 'assignment' && isSplitAssignment(courseName, taskName)) {
                            updateDayCardSplitProgress(card, courseName, taskName);
                        }

                        // Update completion state (X button visibility)
                        updateCardCompletionState(card);
                    }
                });
            }


            // --- **NEW:** Day A/B Deduplication Helpers ---

            // Returns the other day's ID
            function getOtherDayId(currentDayId) {
                return currentDayId === 'dayA' ? 'dayB' : 'dayA';
            }

            // Returns a Set of lesson/assignment names already used in the OTHER day for a given course
            function getNamesUsedInOtherDay(courseName, type, currentDayId) {
                const otherDayId = getOtherDayId(currentDayId);
                const otherDayContainer = document.getElementById(otherDayId);
                const usedNames = new Set();
                if (!otherDayContainer) return usedNames;

                const selector = type === 'lesson' ? '.task-lesson-name' : '.task-assignment-name';

                otherDayContainer.querySelectorAll('.course-card').forEach(card => {
                    const cardCourseName = card.getAttribute('data-course-name') || card.querySelector('h3').textContent.trim();
                    if (cardCourseName === courseName) {
                        const field = card.querySelector(selector);
                        if (field && field.value.trim() !== '') {
                            usedNames.add(field.value.trim());
                        }
                    }
                });
                return usedNames;
            }

            // Checks if a course has ANY split assignment (scope limitation for dedup)
            function courseHasAnySplitAssignment(courseName) {
                const splits = getSplitAssignments();
                return Object.keys(splits).some(key => key.startsWith(courseName + '::'));
            }

            // --- **NEW FUNCTION:** Get next unfinished assignment for a course
            function getNextUnfinishedAssignment(courseName, excludeNames) {
                const data = JSON.parse(localStorage.getItem(LS_ASSIGNMENTS_KEY)) || [];
                const courseAssignments = data.filter(item => item.course === courseName);

                // Find the first assignment that is NOT finished and NOT in excludeNames
                const nextAssignment = courseAssignments.find(item =>
                    item.status === 'Not Started' &&
                    (!excludeNames || !excludeNames.has(item.name))
                );
                return nextAssignment ? nextAssignment.name : null;
            }

            // --- **NEW FUNCTION:** Auto-populate lesson links
            function autoPopulateLessonLinks(courseCard, lessonName) {
                const courseTitle = courseCard.querySelector('h3').textContent.trim();
                if (lessonName) {
                    const lessonLinks = getLessonLink(courseTitle, lessonName);
                    if (lessonLinks) {
                        const linkField = courseCard.querySelector('.task-link');
                        if (linkField) {
                            linkField.value = lessonLinks;
                            applyThemeColor(linkField);
                            renderEmbed(courseCard, lessonLinks);
                        }
                    }
                }
            }

            // --- **NEW FUNCTION:** Auto-populate assignment field (Multi-Assignment Aware)
            function autoPopulateAssignmentField(courseCard) {
                const courseTitle = courseCard.querySelector('h3').textContent.trim();
                const assignmentField = courseCard.querySelector('.task-assignment-name'); // This gets the first one

                // NEW: Check for Multi-Assignment Mapping first
                const map = JSON.parse(localStorage.getItem('tracker_lesson_assignments_map')) || {};
                const lessonName = courseCard.querySelector('.task-lesson-name').value.trim();
                const key = `${courseTitle}::${lessonName}`;

                if (lessonName && map[key] && Array.isArray(map[key]) && map[key].length > 0) {
                    const linkedAssignments = map[key];
                    const li = courseCard.querySelector('.task-list li');
                    let container = li.querySelector('.task-assignments-container');

                    // Ensure container exists
                    if (!container) {
                        container = document.createElement('div');
                        container.className = 'task-assignments-container';
                        const existingRow = li.querySelector('.task-assignment-main');
                        existingRow.parentNode.insertBefore(container, existingRow);
                        container.appendChild(existingRow);
                    }

                    container.innerHTML = ''; // Clear existing

                    // Fetch existing assignment data to sync types/indentation
                    const existingData = JSON.parse(localStorage.getItem(LS_ASSIGNMENTS_KEY)) || [];

                    linkedAssignments.forEach(aName => {
                        // Find this assignment in the tracker to get its current type/indent state
                        const stored = existingData.find(d => d.course === courseTitle && d.name === aName);

                        const row = createAssignmentRow(
                            aName,
                            false,
                            stored ? stored.isIndented : false,
                            stored ? stored.isOutdented : false,
                            stored ? stored.type : 'assignment'
                        );
                        container.appendChild(row);
                    });

                    if (linkedAssignments.length > 1) {
                        li.classList.add('has-multiple-assignments');
                    } else {
                        li.classList.remove('has-multiple-assignments');
                    }

                    resizeFieldsForActiveDay(courseCard.closest('.tab-content').id);
                    updateCardCompletionState(courseCard);
                    saveData(courseCard.closest('.tab-content').id);
                    return;
                }

                // FALLBACK: Old logic (Next Unfinished)
                // Only auto-populate if assignment field is empty
                if (assignmentField && assignmentField.value.trim() === '') {
                    // Dedup: exclude names already used in the other day (if no split assignments)
                    let excludeNames = null;
                    const dayId = courseCard.closest('.tab-content')?.id;
                    if (dayId && dayId.startsWith('day') && !courseHasAnySplitAssignment(courseTitle)) {
                        excludeNames = getNamesUsedInOtherDay(courseTitle, 'assignment', dayId);
                    }

                    const nextAssignment = getNextUnfinishedAssignment(courseTitle, excludeNames);
                    if (nextAssignment) {
                        assignmentField.value = nextAssignment;
                        applyThemeColor(assignmentField);
                        resizeFieldsForActiveDay(courseCard.closest('.tab-content').id);
                        // Update completion state after populating
                        updateCardCompletionState(courseCard);
                    }
                }
            }

            // --- 3. Global Button Logic (MODIFIED to switch tabs) ---
            // These buttons are now the *only* way to access the tracker tabs
            document.getElementById('lessonTrackerBtn').addEventListener('click', () => {
                switchDay('lessonTracker');
            });

            document.getElementById('assignmentTrackerBtn').addEventListener('click', () => {
                switchDay('assignmentTracker');
            });

            document.getElementById('backupBtn').addEventListener('click', () => {
                switchDay('backupTab');
            });

            // --- 4. Checkbox Click Logic & Link Change (UPDATED to include Tracker Sync) ---
            mainContent.addEventListener('change', (event) => {
                const target = event.target;

                // 1. Link input change detection
                if (target.classList.contains('task-link')) {
                    const courseCard = target.closest('.course-card');
                    renderEmbed(courseCard, target.value);
                    // **NEW:** Mark as unsaved
                    hasUnsavedChanges = true;
                    return;
                }

                // 2. Task Checkbox Change Detection (NEW SYNC LOGIC)
                if (target.classList.contains('task-checkbox')) {
                    const courseCard = target.closest('.course-card');
                    const courseTitle = courseCard.querySelector('h3').textContent.trim();
                    const isChecked = target.checked;

                    let taskNameField;
                    let taskType;

                    if (target.classList.contains('task-lesson-checkbox')) {
                        taskType = 'lesson';
                        taskNameField = courseCard.querySelector('.task-lesson-name');
                    } else if (target.classList.contains('task-assignment-checkbox')) {
                        taskType = 'assignment';
                        // Fix: Select the specific assignment name related to this checkbox
                        taskNameField = target.closest('.task-main').querySelector('.task-assignment-name');
                    }

                    if (taskNameField && taskNameField.value.trim() !== '') {
                        const assignmentName = taskNameField.value.trim();

                        // **NEW:** Check if this is a split assignment
                        if (taskType === 'assignment' && isSplitAssignment(courseTitle, assignmentName)) {
                            // Handle split assignment progress
                            if (isChecked) {
                                const result = advanceSplitAssignmentProgress(courseTitle, assignmentName);

                                if (result && !result.isComplete) {
                                    // Not fully complete yet - uncheck the checkbox
                                    target.checked = false;
                                    // Update the visual progress
                                    updateDayCardSplitProgress(courseCard, courseTitle, assignmentName);
                                } else if (result && result.isComplete) {
                                    // Fully complete - update tracker status
                                    updateTrackerItemStatusFromCard(courseTitle, taskType, assignmentName, true);
                                    updateDayCardSplitProgress(courseCard, courseTitle, assignmentName);
                                }
                            } else {
                                // Unchecking a split assignment - reset progress
                                const splitData = getSplitAssignment(courseTitle, assignmentName);
                                if (splitData && splitData.completedDays > 0) {
                                    setSplitAssignment(courseTitle, assignmentName, splitData.totalDays, splitData.completedDays - 1);
                                    updateDayCardSplitProgress(courseCard, courseTitle, assignmentName);
                                }
                                updateTrackerItemStatusFromCard(courseTitle, taskType, assignmentName, false);
                            }
                        } else {
                            // Normal checkbox behavior
                            updateTrackerItemStatusFromCard(courseTitle, taskType, assignmentName, isChecked);
                        }
                    }

                    // **NEW:** Update Day A/B Card Completion State
                    if (courseCard) {
                        updateCardCompletionState(courseCard);
                    }

                    // **NEW:** Mark as unsaved
                    hasUnsavedChanges = true;
                }
            });

            // --- III. Search & Suggestion Logic (UPDATED to filter by "Not Started" and trigger completion check on name input) ---
            mainContent.addEventListener('input', (event) => {
                const target = event.target;

                // 1. Textarea Resize & Color Logic 
                if (target.classList.contains('task-notes') || target.classList.contains('task-name')) {
                    target.style.height = '0'; // FIX: Reset height to 0 before calculating scrollHeight
                    target.style.height = (target.scrollHeight) + 'px';
                }

                if (target.classList.contains('task-name') ||
                    target.classList.contains('task-notes') ||
                    target.classList.contains('task-link')) {

                    applyThemeColor(target);
                    // **NEW:** Also check completion state when task names change
                    const courseCard = target.closest('.course-card');
                    if (courseCard) {
                        updateCardCompletionState(courseCard);
                        // **NEW:** Update autofill button visibility on manual name change
                        updateAutofillButtonVisibility();
                    }

                    // **NEW:** Mark as unsaved
                    hasUnsavedChanges = true;

                    // **NEW:** Instant Visual Update for Split Assignments
                    if (target.classList.contains('task-assignment-name')) {
                        const card = target.closest('.course-card');
                        const cName = card.querySelector('h3').textContent.trim();
                        updateDayCardSplitProgress(card, cName, target.value.trim());
                    }
                }

                // 2. Search Logic (MODIFIED FILTERING)
                if (target.classList.contains('task-name')) {

                    const isLesson = target.classList.contains('task-lesson-name');
                    const trackerType = isLesson ? 'lesson' : 'assignment';

                    const suggestionsList = target.closest('.task-name-wrapper').querySelector('.search-suggestions');
                    const courseTitle = target.closest('.course-card').querySelector('h3').textContent.trim();
                    const searchTerm = target.value.trim().toLowerCase();

                    suggestionsList.innerHTML = '';
                    suggestionsList.classList.remove('active');

                    if (searchTerm.length < 2) {
                        return;
                    }

                    const storageKey = trackerType === 'lesson' ? LS_LESSONS_KEY : LS_ASSIGNMENTS_KEY;
                    const data = JSON.parse(localStorage.getItem(storageKey)) || [];

                    // Dedup: get names used in the other day for this course
                    const currentDayId = target.closest('.tab-content')?.id;
                    let otherDayNames = new Set();
                    const isAssignment = !isLesson;
                    if (currentDayId && currentDayId.startsWith('day')) {
                        // For lessons: always dedup. For assignments: only if no split assignments
                        if (isLesson || !courseHasAnySplitAssignment(courseTitle)) {
                            otherDayNames = getNamesUsedInOtherDay(courseTitle, trackerType, currentDayId);
                        }
                    }

                    // MODIFICATION: Filter items to only show those that are 'Not Started' and not in the other day
                    const filteredResults = data.filter(item =>
                        item.course === courseTitle &&
                        item.name.toLowerCase().includes(searchTerm) &&
                        item.status === 'Not Started' &&
                        !otherDayNames.has(item.name)
                    );

                    if (filteredResults.length > 0) {
                        filteredResults.slice(0, 5).forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = item.name;
                            li.setAttribute('data-name', item.name);
                            li.addEventListener('click', (e) => {
                                target.value = e.target.getAttribute('data-name');
                                applyThemeColor(target);
                                resizeFieldsForActiveDay(target.closest('.tab-content').id); // Trigger resize after selection
                                // **NEW:** Check completion state after selecting a suggestion
                                const suggestionCourseCard = target.closest('.course-card');
                                if (suggestionCourseCard) {
                                    updateCardCompletionState(suggestionCourseCard);

                                    // **NEW:** Auto-populate assignment field if this is a lesson selection
                                    if (isLesson) {
                                        autoPopulateAssignmentField(suggestionCourseCard);
                                        autoPopulateLessonLinks(suggestionCourseCard, e.target.getAttribute('data-name'));
                                    } else {
                                        // **NEW:** Check if selected assignment is a split assignment
                                        const selectedName = e.target.getAttribute('data-name');
                                        if (isSplitAssignment(courseTitle, selectedName)) {
                                            updateDayCardSplitProgress(suggestionCourseCard, courseTitle, selectedName);
                                        }
                                    }
                                }
                                suggestionsList.classList.remove('active');
                            });
                            suggestionsList.appendChild(li);
                        });
                        suggestionsList.classList.add('active');
                    }
                }
            });

            // Hide suggestions when clicking outside (UNCHANGED)
            document.addEventListener('click', (event) => {
                if (!event.target.closest('.task-name-wrapper')) {
                    document.querySelectorAll('.search-suggestions').forEach(list => {
                        list.classList.remove('active');
                    });
                }
            });

            // **NEW:** Check for split assignments when assignment field loses focus
            // **NEW:** Check for split assignments and auto-populate lesson links when name fields lose focus
            mainContent.addEventListener('blur', (event) => {
                const target = event.target;
                const courseCard = target.closest('.course-card');
                if (!courseCard) return;

                const courseName = courseCard.querySelector('h3').textContent.trim();

                // Check for split assignments when assignment field loses focus
                if (target.classList.contains('task-assignment-name')) {
                    const assignmentName = target.value.trim();
                    if (assignmentName && isSplitAssignment(courseName, assignmentName)) {
                        updateDayCardSplitProgress(courseCard, courseName, assignmentName);
                    }
                }

                // Auto-populate lesson links when lesson name field loses focus
                if (target.classList.contains('task-lesson-name')) {
                    const lessonName = target.value.trim();
                    autoPopulateLessonLinks(courseCard, lessonName);
                }
            }, true);

            // **NEW:** Handle clicks on progress circles in Day A/B cards
            mainContent.addEventListener('click', (event) => {
                const progressWrapper = event.target.closest('.progress-circle-wrapper');
                const courseCard = event.target.closest('.course-card[data-day]');

                if (progressWrapper && courseCard) {
                    event.preventDefault();
                    event.stopPropagation();

                    const courseName = progressWrapper.getAttribute('data-course');
                    const assignmentName = progressWrapper.getAttribute('data-assignment');

                    // **NEW:** Check current state to determine action (Advance or Reset)
                    const currentSplit = getSplitAssignment(courseName, assignmentName);
                    if (!currentSplit) return;

                    let result;
                    const curTotal = Number(currentSplit.totalDays);
                    const curCompleted = Number(currentSplit.completedDays);

                    // If currently fully complete, clicking it should RESET it to 0 (Uncheck)
                    if (curCompleted >= curTotal) {
                        setSplitAssignment(courseName, assignmentName, curTotal, 0);
                        result = {
                            totalDays: curTotal,
                            completedDays: 0,
                            isComplete: false
                        };
                        // Update tracker status to Not Started
                        updateTrackerItemStatusFromCard(courseName, 'assignment', assignmentName, false);

                    } else {
                        // Otherwise, advance progress
                        result = advanceSplitAssignmentProgress(courseName, assignmentName);
                        // If it BECAME complete, update tracker
                        if (result.isComplete) {
                            updateTrackerItemStatusFromCard(courseName, 'assignment', assignmentName, true);
                        }
                    }

                    if (result) {
                        // **NEW:** Update interaction state via checkbox (checked if > 0 progress)
                        const cb = courseCard.querySelector('.task-assignment-checkbox');
                        if (cb) cb.checked = (result.completedDays > 0);

                        // Update the visual progress - PASS RESULT AS OVERRIDE
                        updateDayCardSplitProgress(courseCard, courseName, assignmentName, result);
                        updateCardCompletionState(courseCard);
                        hasUnsavedChanges = true;
                    }
                }
            });

            // **NEW FUNCTION:** Delete/Clear all content from a Day A/B Course Card
            function deleteDayTaskCard(courseCard, shouldSync = true) {
                const courseTitle = courseCard.querySelector('h3').textContent.trim(); // Get course name
                const li = courseCard.querySelector('.task-list li');

                // Lesson
                const lName = li.querySelector('.task-lesson-name');
                const lCheckbox = li.querySelector('.task-lesson-checkbox');

                if (shouldSync && lName.value.trim() !== '' && lCheckbox.checked) {
                    updateTrackerItemStatusFromCard(courseTitle, 'lesson', lName.value.trim(), false);
                }

                lName.value = '';
                lCheckbox.checked = false;
                applyThemeColor(lName);

                // Assessments (Handle Multiple)
                const assignmentRows = li.querySelectorAll('.task-assignment-main');
                assignmentRows.forEach((row, index) => {
                    const aName = row.querySelector('.task-assignment-name');
                    const aCheckbox = row.querySelector('.task-assignment-checkbox');
                    const wrapper = row.querySelector('.progress-circle-wrapper');

                    // Sync
                    if (shouldSync && aName && aName.value.trim() !== '' && aCheckbox.checked) {
                        updateTrackerItemStatusFromCard(courseTitle, 'assignment', aName.value.trim(), false);

                        // Reset split progress if applicable
                        if (isSplitAssignment(courseTitle, aName.value.trim())) {
                            const splitData = getSplitAssignment(courseTitle, aName.value.trim());
                            if (splitData) {
                                setSplitAssignment(courseTitle, aName.value.trim(), splitData.totalDays, 0);
                            }
                        }
                    }

                    if (index === 0) {
                        // Reset first one
                        aName.value = '';
                        aCheckbox.checked = false;
                        aCheckbox.style.display = ''; // Restore visibility
                        applyThemeColor(aName);
                        if (wrapper) wrapper.remove();
                    } else {
                        // Remove others
                        row.remove();
                    }
                });

                // Reset container class
                li.classList.remove('has-multiple-assignments');

                // Notes/Link
                const notes = li.querySelector('.task-notes');
                const link = li.querySelector('.task-link');
                const embedArea = courseCard.querySelector('.course-embed-container');

                notes.value = '';
                applyThemeColor(notes);

                link.value = '';
                applyThemeColor(link);
                embedArea.innerHTML = '';
                embedArea.style.display = 'none';

                // Reset heights and completion state
                resizeFieldsForActiveDay(courseCard.closest('.tab-content').id);
                updateCardCompletionState(courseCard); // Hides the X button

                hasUnsavedChanges = true; // Mark as unsaved

                // **NEW:** Update autofill button visibility after clearing a card
                updateAutofillButtonVisibility();
            }


            // --- 5. Save Logic (UPDATED to reset unsaved flag) ---
            document.getElementById('saveBtn').addEventListener('click', () => {
                saveData('dayA');
                saveData('dayB');

                // **NEW:** Reset unsaved state after a successful save
                hasUnsavedChanges = false;

                const saveBtn = document.getElementById('saveBtn');
                const originalText = saveBtn.textContent;

                saveBtn.textContent = 'Saved!';
                saveBtn.classList.add('saved-state');
                saveBtn.disabled = true;

                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.classList.remove('saved-state');
                    saveBtn.disabled = false;
                }, 2000);
            });

            // --- **NEW:** Autofill Functionality ---

            // Check if all cards in a specific day are empty
            function checkIfAllCardsEmpty(dayId) {
                const dayContainer = document.getElementById(dayId);
                if (!dayContainer) return false;

                const cards = dayContainer.querySelectorAll('.course-card');
                let allEmpty = true;

                cards.forEach(card => {
                    // Skip paused cards in the check
                    if (card.classList.contains('paused')) {
                        return;
                    }

                    const lessonNameField = card.querySelector('.task-lesson-name');
                    const assignmentNameField = card.querySelector('.task-assignment-name');

                    const hasLesson = lessonNameField && lessonNameField.value.trim() !== '';
                    const hasAssignment = assignmentNameField && assignmentNameField.value.trim() !== '';

                    if (hasLesson || hasAssignment) {
                        allEmpty = false;
                    }
                });

                return allEmpty;
            }

            // Update autofill button visibility based on whether all cards are empty
            function updateAutofillButtonVisibility() {
                const autofillBtn = document.getElementById('autofillBtn');
                if (!autofillBtn) return;

                // Get the currently active tab
                const activeTab = document.querySelector('.tab-content.active');
                if (!activeTab || !activeTab.id.startsWith('day')) {
                    autofillBtn.classList.add('hidden');
                    return;
                }

                const dayId = activeTab.id;
                const isDayEmpty = checkIfAllCardsEmpty(dayId);

                // Show button only if the CURRENTLY ACTIVE Day is empty
                if (isDayEmpty) {
                    autofillBtn.classList.remove('hidden');
                } else {
                    autofillBtn.classList.add('hidden');
                }
            }

            // Autofill all cards with next unfinished lessons and assignments
            function autofillAllCards() {
                const pausedCourses = getPausedCourses().lesson || [];

                // Get the currently active day tab
                const activeTab = document.querySelector('.tab-content.active');
                if (!activeTab || !activeTab.id.startsWith('day')) return;

                const dayId = activeTab.id;
                const dayContainer = document.getElementById(dayId);
                const cards = dayContainer.querySelectorAll('.course-card');

                cards.forEach(card => {
                    const courseName = card.getAttribute('data-course-name') || card.querySelector('h3').textContent.trim();

                    // Skip paused courses
                    if (pausedCourses.includes(courseName)) {
                        return;
                    }

                    const lessonNameField = card.querySelector('.task-lesson-name');
                    const assignmentNameField = card.querySelector('.task-assignment-name');

                    // Dedup: get names already used in the other day for this course
                    const lessonExclude = getNamesUsedInOtherDay(courseName, 'lesson', dayId);
                    const assignmentExclude = courseHasAnySplitAssignment(courseName)
                        ? new Set()
                        : getNamesUsedInOtherDay(courseName, 'assignment', dayId);

                    // Get next unfinished lesson (excluding other day's lesson)
                    const lessonsData = JSON.parse(localStorage.getItem(LS_LESSONS_KEY)) || [];
                    const nextLesson = lessonsData.find(item =>
                        item.course === courseName && item.status === 'Not Started' &&
                        !lessonExclude.has(item.name)
                    );

                    if (nextLesson && lessonNameField) {
                        lessonNameField.value = nextLesson.name;
                        applyThemeColor(lessonNameField);

                        // Auto-populate lesson links for this lesson
                        autoPopulateLessonLinks(card, nextLesson.name);
                    }

                    // Get next unfinished assignment (excluding other day's assignment)
                    const assignmentsData = JSON.parse(localStorage.getItem(LS_ASSIGNMENTS_KEY)) || [];
                    const nextAssignment = assignmentsData.find(item =>
                        item.course === courseName && item.status === 'Not Started' &&
                        !assignmentExclude.has(item.name)
                    );

                    if (nextAssignment && assignmentNameField) {
                        assignmentNameField.value = nextAssignment.name;
                        applyThemeColor(assignmentNameField);

                        // Check if it's a split assignment and update progress
                        if (isSplitAssignment(courseName, nextAssignment.name)) {
                            updateDayCardSplitProgress(card, courseName, nextAssignment.name);
                        }
                    }

                    // Update completion state for this card
                    updateCardCompletionState(card);
                });

                // Resize textareas in the active day
                resizeFieldsForActiveDay(dayId);

                // Mark as unsaved changes
                hasUnsavedChanges = true;

                // Hide the autofill button after filling
                updateAutofillButtonVisibility();

                // Auto-save only the active day's data
                saveData(dayId);
            }

            function createAssignmentRow(name = '', checked = false, isIndented = false, isOutdented = false, type = 'assignment') {
                const row = document.createElement('div');
                row.className = 'task-main task-assignment-main';
                row.style.position = 'relative'; // For absolute positioning of remove button
                if (isIndented) row.classList.add('manual-indent');
                if (isOutdented) row.classList.add('force-no-indent');

                // Connector line (visual only)
                const connector = document.createElement('div');
                connector.className = 'task-connector-line';

                const displayType = type.charAt(0).toUpperCase() + type.slice(1);
                row.innerHTML = `
                    <div class="task-type-label"><span class="task-type-text">${displayType}</span>:</div>
                    <div class="task-name-wrapper">
                        <textarea class="task-name task-assignment-name" placeholder="Assignment Name">${name}</textarea>
                        <ul class="search-suggestions task-assignment-suggestions"></ul>
                    </div>
                    <input type="checkbox" class="task-checkbox task-assignment-checkbox" ${checked ? 'checked' : ''}>
                `;

                // **NEW:** Indentation & Type State Cycling
                const label = row.querySelector('.task-type-label');
                const typeSpan = label.querySelector('.task-type-text');

                // Check and enforce restricted indentation logic
                function updateIndentationBehavior() {
                    const card = row.closest('.course-card');
                    if (!card) return;

                    const lessonName = card.querySelector('.task-lesson-name').value.trim();
                    const isPartOfLesson = lessonName !== '';

                    if (!isPartOfLesson) {
                        // Standalone: No indent or outdent
                        label.style.cursor = 'default';
                        label.removeAttribute('title'); // Removed "Standalone items cannot be indented"
                        // Ensure tags still show cycle tooltip
                        typeSpan.style.cursor = 'pointer';
                        typeSpan.title = 'Click to cycle type';
                        // Remove indentation classes if any
                        row.classList.remove('manual-indent', 'force-no-indent');
                    } else {
                        // Under a lesson: Allow toggle between "Default (Indented)" and "Outdented"
                        label.style.cursor = 'pointer';
                        label.title = 'Click to toggle indentation';
                        typeSpan.style.cursor = 'pointer';
                        typeSpan.title = 'Click to cycle type';
                    }
                }

                // Call initially and also set up listener for lesson name changes
                setTimeout(() => {
                    updateIndentationBehavior();
                    const card = row.closest('.course-card');
                    if (card) {
                        const lessonInput = card.querySelector('.task-lesson-name');
                        lessonInput.addEventListener('input', updateIndentationBehavior);
                    }
                }, 0);

                // Click label (outside the span) to cycle INDENTATION
                label.onclick = function (e) {
                    const card = row.closest('.course-card');
                    const lessonName = card ? card.querySelector('.task-lesson-name').value.trim() : '';
                    if (!lessonName) return; // Ignore for standalone

                    const dayId = row.closest('.tab-content').id;

                    // Logic: Only cycle between "Naturally Indented" (empty class) and "Forced Outdent" (force-no-indent)
                    // "manual-indent" (40px) is basically disabled now since 24px is default for lesson items.
                    if (row.classList.contains('force-no-indent')) {
                        row.classList.remove('force-no-indent');
                    } else {
                        row.classList.add('force-no-indent');
                        row.classList.remove('manual-indent');
                    }
                    saveData(dayId);
                };

                // Click the span to cycle TYPE
                typeSpan.onclick = function (e) {
                    e.stopPropagation(); // Don't trigger indentation toggle
                    const dayId = row.closest('.tab-content').id;
                    const types = ['Assignment', 'Quiz', 'Discussion'];
                    let currentType = typeSpan.textContent.trim();
                    let nextIndex = (types.indexOf(currentType) + 1) % types.length;
                    typeSpan.textContent = types[nextIndex];
                    saveData(dayId);
                };

                // Add remove button
                const removeBtn = document.createElement('button');
                removeBtn.className = 'task-remove-assignment-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.title = 'Remove assignment';
                removeBtn.setAttribute('aria-label', 'Remove assignment');
                removeBtn.onclick = function (e) {
                    e.stopPropagation(); // Prevent label click
                    const container = row.parentElement;
                    const dayId = row.closest('.tab-content').id;
                    row.remove();
                    if (container.querySelectorAll('.task-assignment-main').length <= 1) {
                        const li = container.closest('li');
                        if (li) li.classList.remove('has-multiple-assignments');
                    }
                    saveData(dayId);
                };
                row.prepend(removeBtn);

                return row;
            }

            function saveData(dayId) {
                const dayContainer = document.getElementById(dayId);
                const tasks = {};

                dayContainer.querySelectorAll('.course-card').forEach((card) => {
                    const courseTitle = card.querySelector('h3').textContent.trim();
                    const li = card.querySelector('.task-list li');

                    // New: Lesson Task
                    const lessonTask = {
                        name: li.querySelector('.task-lesson-name').value,
                        checked: li.querySelector('.task-lesson-checkbox').checked,
                    };

                    // New: Assignment Tasks (Array)
                    const assignmentTasks = [];
                    li.querySelectorAll('.task-assignment-main').forEach(row => {
                        const typeSpan = row.querySelector('.task-type-text');
                        const typeText = typeSpan ? typeSpan.textContent.trim() : 'Assignment';

                        assignmentTasks.push({
                            name: row.querySelector('.task-assignment-name').value,
                            checked: row.querySelector('.task-assignment-checkbox').checked,
                            isIndented: row.classList.contains('manual-indent'),
                            isOutdented: row.classList.contains('force-no-indent'),
                            type: typeText.toLowerCase()
                        });
                    });

                    // Notes and Link (Shared)
                    const notes = li.querySelector('.task-notes').value;
                    const link = li.querySelector('.task-link').value;

                    // Save both tasks, notes, and link under the course
                    tasks[courseTitle] = {
                        lesson: lessonTask,
                        assignments: assignmentTasks, // Save as array
                        notes: notes,
                        link: link,
                    };
                });

                localStorage.setItem(`${dayId}_data`, JSON.stringify(tasks));
            }

            // --- 6. Load Logic (UPDATED to call new resize function, completion check, and pause state) ---
            function loadData() {
                initializeTrackerData(); // Initialize/Load Tracker data first

                loadDay('dayA');
                loadDay('dayB');

                // Apply pause state to day cards
                const pausedCourses = getPausedCourses().lesson; // Only need one list due to sync
                ALL_COURSE_NAMES.forEach(courseName => {
                    const isPaused = pausedCourses.includes(courseName);
                    updateDayCardPauseState(courseName, isPaused);
                });

                // Select all fields for color application
                document.querySelectorAll('.task-list textarea, .task-link').forEach(field => {
                    applyThemeColor(field);
                });

                // **NEW:** Check completion state for all cards after loading data
                document.querySelectorAll('.course-card').forEach(card => {
                    updateCardCompletionState(card);
                });

                // **NEW:** Reorder day cards to push paused cards to the back
                reorderDayCards('dayA');
                reorderDayCards('dayB');

                // **FIX:** Increased delay to 100ms to handle hard refresh (Ctrl+Shift+R) cache clearing
                setTimeout(() => resizeAllDayFields(), 100);

                // **NEW:** Ensure the state is clean when loading from scratch/localstorage
                hasUnsavedChanges = false;

                // **NEW:** Update autofill button visibility after loading data
                updateAutofillButtonVisibility();

                autoSelectDay();
            }

            // --- **NEW:** Autofill Button Event Listener ---
            document.getElementById('autofillBtn').addEventListener('click', () => {
                autofillAllCards();
            });

            function loadDay(dayId) {
                const data = JSON.parse(localStorage.getItem(`${dayId}_data`));
                if (!data) return;

                const dayContainer = document.getElementById(dayId);

                dayContainer.querySelectorAll('.course-card').forEach(card => {
                    const courseTitle = card.querySelector('h3').textContent.trim();
                    const courseData = data[courseTitle]; // courseData now contains lesson, assignments (array), notes, link

                    if (courseData) {
                        const li = card.querySelector('.task-list li');

                        // Lesson
                        if (courseData.lesson) {
                            li.querySelector('.task-lesson-name').value = courseData.lesson.name;
                            li.querySelector('.task-lesson-checkbox').checked = courseData.lesson.checked;
                        }

                        // Assignments (Handle Migration: Object -> Array)
                        const assignmentsContainer = li.querySelector('.task-assignments-container') || (() => {
                            // If container doesn't exist yet (legacy HTML), create it
                            const container = document.createElement('div');
                            container.className = 'task-assignments-container';
                            const oldAssignmentRow = li.querySelector('.task-assignment-main');
                            if (oldAssignmentRow) {
                                // Move existing row into container
                                oldAssignmentRow.parentNode.insertBefore(container, oldAssignmentRow);
                                container.appendChild(oldAssignmentRow);

                                // Add remove button to initial row too, but hide it if it's the only one
                                const removeBtn = document.createElement('button');
                                removeBtn.className = 'task-remove-assignment-btn';
                                removeBtn.innerHTML = '&times;';
                                removeBtn.onclick = function () {
                                    if (container.children.length > 1) {
                                        oldAssignmentRow.remove();
                                        if (container.children.length <= 1) li.classList.remove('has-multiple-assignments');
                                        saveData(dayId);
                                    } else {
                                        // Don't remove last one, just clear it
                                        oldAssignmentRow.querySelector('.task-assignment-name').value = '';
                                        oldAssignmentRow.querySelector('.task-assignment-checkbox').checked = false;
                                        saveData(dayId);
                                    }
                                };
                                oldAssignmentRow.appendChild(removeBtn);
                            }
                            return container;
                        })();

                        // Clear existing rows in container (except one if we want to be safe, but rebuilding is cleaner)
                        assignmentsContainer.innerHTML = '';

                        let assignmentsToRender = [];
                        if (courseData.assignments && Array.isArray(courseData.assignments)) {
                            assignmentsToRender = courseData.assignments;
                        } else if (courseData.assignment) {
                            // Legacy single assignment object
                            assignmentsToRender = [courseData.assignment];
                        } else {
                            // Fallback empty
                            assignmentsToRender = [{ name: '', checked: false }];
                        }

                        assignmentsToRender.forEach(assignment => {
                            const row = createAssignmentRow(
                                assignment.name,
                                assignment.checked,
                                assignment.isIndented,
                                assignment.isOutdented,
                                assignment.type || 'assignment'
                            );
                            assignmentsContainer.appendChild(row);

                            // Check split assignment status for each
                            if (assignment.name && isSplitAssignment(courseTitle, assignment.name)) {
                                const checkboxRow = row.querySelector('.task-assignment-main') || row; // createAssignmentRow returns the row div
                                // We need to pass the card context, but updateDayCardSplitProgress expects the card.
                                // However, it looks for .task-assignment-main INSIDE the card.
                                // Since we just appended the row, we might need to target it specifically.
                                // Let's use a modified version of updateDayCardSplitProgress or just call it after append?
                                // The function updateDayCardSplitProgress finds the assignment by name within the card? 
                                // No, it takes the card and scans?
                                // Actually, updateDayCardSplitProgress (scanned above) finds .task-assignment-main. 
                                // If there are multiple, it might fail or only update the first one.
                                // FIX: We need to update existing split logic to handle multiple assignments.
                                // OLD LOGIC: `const assignmentCheckboxDiv = courseCard.querySelector('.task-assignment-main');` -> Only finds first.
                                // We will need to update that separately. For now, let's just render.
                            }
                        });

                        if (assignmentsToRender.length > 1) {
                            li.classList.add('has-multiple-assignments');
                        } else {
                            li.classList.remove('has-multiple-assignments');
                        }

                        // Shared Notes and Link
                        li.querySelector('.task-notes').value = courseData.notes || '';

                        const linkInput = li.querySelector('.task-link');
                        linkInput.value = courseData.link || '';
                        renderEmbed(card, linkInput.value);
                    }
                });

                // Update hrefs for all courses in this day
                ALL_COURSE_NAMES.forEach(courseName => {
                    updateCourseH3Href(courseName);
                });

                // IMPORTANT: Resize fields after loading data
                resizeFieldsForActiveDay(dayId);

                // Post-load: Update Split Progress for ALL assignments in the card
                dayContainer.querySelectorAll('.course-card').forEach(card => {
                    const courseTitle = card.querySelector('h3').textContent.trim();
                    card.querySelectorAll('.task-assignment-name').forEach(input => {
                        const val = input.value.trim();
                        if (val && isSplitAssignment(courseTitle, val)) {
                            // We need a way to target the specific row's progress wrapper.
                            // The current updateDayCardSplitProgress uses querySelector('.task-assignment-main'), which is ambiguous if multiple exist.
                            // We should fix that function or pass the specific row container.
                            // For now, let's just trigger it and see.
                            updateDayCardSplitProgress(card, courseTitle, val);
                        }
                    });
                });
            }

            // --- 7. Reset Logic (UPDATED for consistency) ---
            document.getElementById('resetBtn').addEventListener('click', () => {
                const activeTab = document.querySelector('.tab-content.active');
                const dayId = activeTab.id;

                const formattedDay = dayId.startsWith(TAB_PREFIX)
                    ? dayId.charAt(0).toUpperCase() + dayId.slice(1).replace('y', 'y ')
                    : 'the current tracker';

                if (confirm(`Are you sure you want to reset all fields for ${formattedDay}? (Custom links will be preserved)`)) {

                    if (dayId.startsWith(TAB_PREFIX)) {
                        localStorage.removeItem(`${dayId}_data`);
                        localStorage.removeItem('selectedDay');

                        // Clear the UI fields for Day A/B without affecting the trackers
                        activeTab.querySelectorAll('.course-card').forEach(card => {
                            deleteDayTaskCard(card, false); // Pass false to skip tracker sync
                        });

                        // **NEW:** Reset unsaved changes flag
                        hasUnsavedChanges = false;

                    } else if (dayId === 'lessonTracker') {
                        localStorage.removeItem(LS_LESSONS_KEY);
                        localStorage.removeItem(LS_PAUSED_COURSES_KEY); // Also reset pause state
                        localStorage.removeItem(LS_LESSON_LINKS_KEY); // Also reset lesson links
                        initializeTrackerData(); // Initialize to empty array
                        renderTracker('lesson');

                    } else if (dayId === 'assignmentTracker') {
                        localStorage.removeItem(LS_ASSIGNMENTS_KEY);
                        localStorage.removeItem(LS_PAUSED_COURSES_KEY); // Also reset pause state
                        localStorage.removeItem(LS_SPLIT_ASSIGNMENTS_KEY); // Also reset split assignments
                        initializeTrackerData(); // Initialize to empty array
                        renderTracker('assignment');
                    }

                    // Since pause state was reset, re-apply it (unpause all)
                    ALL_COURSE_NAMES.forEach(courseName => updateDayCardPauseState(courseName, false));

                    // **NEW:** Update autofill button visibility after reset
                    updateAutofillButtonVisibility();
                }
            });

            // --- Function to apply theme color to a field (MODIFIED for pause override) ---
            function applyThemeColor(field) {
                // Check if the parent card is paused using CSS class check
                const isPaused = field.closest('.course-card').classList.contains('paused');

                if (isPaused) {
                    // If paused, rely purely on the CSS rules added for the '.paused' state.
                    // DO NOT set an inline style, otherwise it will override the CSS.
                    field.style.color = '';
                    return;
                }

                // Default logic for non-paused cards: check if value is empty
                const hasValue = field.value !== '' && field.value !== field.getAttribute('placeholder');

                if (hasValue) {
                    field.style.color = COLOR_INPUT_TEXT; // '#333'
                } else {
                    field.style.color = COLOR_DEFAULT_GRAY;
                }
            }

            // --- NEW: Progress Bar Calculation and Rendering (MODIFIED to ignore paused courses) ---
            function calculateAndRenderOverallProgress(type) {
                const storageKey = type === 'lesson' ? LS_LESSONS_KEY : LS_ASSIGNMENTS_KEY;
                const data = JSON.parse(localStorage.getItem(storageKey)) || [];
                const pausedCourses = getPausedCourses()[type] || []; // Get paused list for this type

                // MODIFICATION: Filter out items whose course is in the pausedCourses list
                const activeData = data.filter(item => !pausedCourses.includes(item.course));

                const finishedCount = activeData.filter(item => item.status === 'Finished').length;
                const totalCount = activeData.length; // Total is now only for active courses
                const percentageFinished = totalCount > 0 ? (finishedCount / totalCount) * 100 : 0;

                const container = document.getElementById(`${type}OverallProgress`);

                if (totalCount === 0) { // Check totalCount from activeData
                    container.innerHTML = '';
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'block';

                container.innerHTML = `
                    <div class="progress-bar-label">
                        <span>Overall Active ${type.charAt(0).toUpperCase() + type.slice(1)} Progress</span>
                        <span>${finishedCount} / ${totalCount} Completed (${percentageFinished.toFixed(0)}%)</span>
                    </div>
                    <div class="progress-bar-outer">
                        <div class="progress-bar-inner" style="width: ${percentageFinished}%"></div>
                    </div>
                `;
            }


            // --- IV. Tracker Logic: Renderer, Add, Toggle, Delete (MODIFIED for simplified form) ---

            // Populates Course Dropdowns on the new item forms
            function populateCourseDropdowns() {
                // Only targeting the bulk fields now, which are the main fields
                const courseSelects = [
                    document.getElementById('bulkLessonCourse'),
                    document.getElementById('bulkAssignmentCourse'),
                    document.getElementById('canvas-import-course')
                ];

                courseSelects.forEach(select => {
                    select.innerHTML = '<option value="" disabled selected>Select Course</option>';
                    ALL_COURSE_NAMES.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course;
                        option.textContent = course;
                        select.appendChild(option);
                    });
                });
            }

            // Add New Item functionality (Simplified to handle only bulk/multi-line paste)
            function addNewItem(type) {
                const typeCapitalized = type.charAt(0).toUpperCase() + type.slice(1);
                const storageKey = type === 'lesson' ? LS_LESSONS_KEY : LS_ASSIGNMENTS_KEY;

                // The bulk fields are now the main fields
                const nameTextarea = document.getElementById(`bulk${typeCapitalized}Names`);
                const courseSelect = document.getElementById(`bulk${typeCapitalized}Course`);

                const names = nameTextarea.value.split('\n').map(name => name.trim()).filter(name => name !== "");
                const course = courseSelect.value;

                if (names.length === 0 || course === "") {
                    alert(`Please paste names and select a course for the new ${type} addition.`);
                    return;
                }

                nameTextarea.value = ''; // Clear textarea after successful bulk paste
                nameTextarea.style.height = '80px'; // Reset textarea height
                courseSelect.selectedIndex = 0; // Reset course select

                let data = JSON.parse(localStorage.getItem(storageKey)) || [];

                names.forEach(name => {
                    const newItem = {
                        id: Date.now() + Math.random(),
                        name: name,
                        course: course,
                        status: 'Not Started'
                    };
                    data.push(newItem);
                });

                localStorage.setItem(storageKey, JSON.stringify(data));

                // Re-render the tracker
                renderTracker(type);

                // Close the modal after successful add
                const modalId = type === 'lesson' ? 'addLessonModal' : 'addAssignmentModal';
                document.getElementById(modalId).classList.remove('active');
            }

            // Button listeners for add items (inside modals)
            document.getElementById('addLessonBtn').addEventListener('click', () => addNewItem('lesson'));
            document.getElementById('addAssignmentBtn').addEventListener('click', () => addNewItem('assignment'));

            // --- **NEW:** Add Items Modal Open/Close/Auto-resize Logic ---

            // Auto-resize textarea helper
            function autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            }

            // Open Add Lessons Modal
            document.getElementById('openAddLessonModal').addEventListener('click', () => {
                const modal = document.getElementById('addLessonModal');
                modal.classList.add('active');
                const textarea = document.getElementById('bulkLessonNames');
                textarea.value = '';
                textarea.style.height = '80px';
                textarea.focus();
            });

            // Open Add Assignments Modal
            document.getElementById('openAddAssignmentModal').addEventListener('click', () => {
                const modal = document.getElementById('addAssignmentModal');
                modal.classList.add('active');
                const textarea = document.getElementById('bulkAssignmentNames');
                textarea.value = '';
                textarea.style.height = '80px';
                textarea.focus();
            });

            // Cancel buttons close modals
            document.getElementById('addLessonModalCancel').addEventListener('click', () => {
                const modal = document.getElementById('addLessonModal');
                modal.classList.remove('active');
                document.getElementById('bulkLessonNames').value = '';
                document.getElementById('bulkLessonNames').style.height = '80px';
            });

            document.getElementById('addAssignmentModalCancel').addEventListener('click', () => {
                const modal = document.getElementById('addAssignmentModal');
                modal.classList.remove('active');
                document.getElementById('bulkAssignmentNames').value = '';
                document.getElementById('bulkAssignmentNames').style.height = '80px';
            });

            // Auto-resize on input for both modal textareas
            document.getElementById('bulkLessonNames').addEventListener('input', function () {
                autoResizeTextarea(this);
            });

            document.getElementById('bulkAssignmentNames').addEventListener('input', function () {
                autoResizeTextarea(this);
            });

            // Close modals when clicking on overlay background
            document.getElementById('addLessonModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    e.currentTarget.classList.remove('active');
                    document.getElementById('bulkLessonNames').value = '';
                    document.getElementById('bulkLessonNames').style.height = '80px';
                }
            });

            document.getElementById('addAssignmentModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    e.currentTarget.classList.remove('active');
                    document.getElementById('bulkAssignmentNames').value = '';
                    document.getElementById('bulkAssignmentNames').style.height = '80px';
                }
            });

            // **NEW HELPER:** Sync Tracker updates to Day Cards
            function syncTrackerInputToDayCards(courseName, type, taskName, isComplete) {
                // Determine selector based on type
                const inputSelector = type === 'lesson' ? '.task-lesson-name' : '.task-assignment-name';
                const checkboxSelector = type === 'lesson' ? '.task-lesson-checkbox' : '.task-assignment-checkbox';

                // Find all cards with this course name (could be in Day A or Day B)
                document.querySelectorAll('.course-card').forEach(card => {
                    if (card.querySelector('h3').textContent.trim() === courseName) {
                        const nameInput = card.querySelector(inputSelector);

                        // Check if the task name matches
                        if (nameInput && nameInput.value.trim() === taskName) {

                            // Check if it's a split assignment first
                            if (type === 'assignment' && isSplitAssignment(courseName, taskName)) {
                                updateDayCardSplitProgress(card, courseName, taskName);
                            } else {
                                // Normal checkbox update
                                const checkbox = card.querySelector(checkboxSelector);
                                if (checkbox) {
                                    checkbox.checked = isComplete;
                                }
                            }

                            // Always update the card's visual completion state (X button etc)
                            updateCardCompletionState(card);
                        }
                    }
                });
            }

            // Toggle Status functionality (used in tracker tabs)
            function toggleTrackerItemStatus(itemId, type) {
                const storageKey = type === 'lesson' ? LS_LESSONS_KEY : LS_ASSIGNMENTS_KEY;
                let data = JSON.parse(localStorage.getItem(storageKey)) || [];

                let updatedItem = null;

                data = data.map(item => {
                    // Note: Item IDs are stored as numbers, so compare numbers
                    if (item.id == itemId) {
                        item.status = item.status === 'Finished' ? 'Not Started' : 'Finished';
                        updatedItem = item;
                    }
                    return item;
                });

                localStorage.setItem(storageKey, JSON.stringify(data));
                renderTracker(type); // Re-render the UI
                calculateAndRenderOverallProgress(type); // NEW: Update progress bar

                // **NEW:** Sync change to Day cards immediately
                if (updatedItem) {
                    syncTrackerInputToDayCards(updatedItem.course, type, updatedItem.name, updatedItem.status === 'Finished');
                }
            }

            // Delete Item functionality (New Function - individual task)
            function deleteTrackerItem(itemId, type) {
                if (!confirm(`Are you sure you want to delete this ${type}? This action cannot be undone.`)) {
                    return;
                }

                const storageKey = type === 'lesson' ? LS_LESSONS_KEY : LS_ASSIGNMENTS_KEY;
                let data = JSON.parse(localStorage.getItem(storageKey)) || [];

                // Find the item before deleting (to get course and name for split assignment cleanup)
                const itemToDelete = data.find(item => item.id == itemId);

                // **NEW:** If this is an assignment, also delete any split assignment data
                if (type === 'assignment' && itemToDelete) {
                    deleteSplitAssignment(itemToDelete.course, itemToDelete.name);
                }

                // Filter out the item with the matching id
                data = data.filter(item => item.id != itemId);

                localStorage.setItem(storageKey, JSON.stringify(data));
                renderTracker(type); // Re-render the UI
                calculateAndRenderOverallProgress(type); // NEW: Update progress bar

                // **NEW:** Sync deletion to day cards (uncheck/reset status)
                if (itemToDelete) {
                    syncTrackerInputToDayCards(itemToDelete.course, type, itemToDelete.name, false);
                }
            }

            // **NEW FUNCTION:** Delete an entire course from the tracker
            function deleteTrackerCourse(courseName, type) {
                if (!confirm(`Are you sure you want to delete ALL tasks for "${courseName}" from the ${type} tracker? This action cannot be undone.`)) {
                    return;
                }

                const storageKey = type === 'lesson' ? LS_LESSONS_KEY : LS_ASSIGNMENTS_KEY;
                let data = JSON.parse(localStorage.getItem(storageKey)) || [];

                // **NEW:** If deleting assignment tracker course, also delete split assignments for all assignments
                if (type === 'assignment') {
                    data.filter(item => item.course === courseName).forEach(item => {
                        deleteSplitAssignment(courseName, item.name);
                    });
                }

                // Filter out all items belonging to the specified course
                data = data.filter(item => item.course !== courseName);

                // Also remove from paused state if it was paused
                let pausedCourses = getPausedCourses();
                pausedCourses[type] = (pausedCourses[type] || []).filter(c => c !== courseName);

                // Ensure the other tracker is also updated in case of synchronization
                const otherType = type === 'lesson' ? 'assignment' : 'lesson';
                pausedCourses[otherType] = (pausedCourses[otherType] || []).filter(c => c !== courseName);

                localStorage.setItem(LS_PAUSED_COURSES_KEY, JSON.stringify(pausedCourses));

                localStorage.setItem(storageKey, JSON.stringify(data));
                renderTracker(type); // Re-render the UI
                calculateAndRenderOverallProgress(type); // NEW: Update progress bar
            }

            // --- **NEW:** Backup & Restore Functionality ---
            function exportData() {
                const backupData = {};

                // Capture ALL keys in localStorage for a complete snapshot
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    if (value !== null) {
                        try {
                            backupData[key] = JSON.parse(value);
                        } catch (e) {
                            backupData[key] = value; // Store as raw string if not JSON
                        }
                    }
                }

                // Ensure lesson_links is included in export, even if empty
                if (!backupData[LS_LESSON_LINKS_KEY]) {
                    backupData[LS_LESSON_LINKS_KEY] = {}; // Store as object, will be stringified below
                }

                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const exportFileDefaultName = `course_planner_backup_${timestamp}.json`;

                const linkElement = document.createElement('a');
                linkElement.href = url;
                linkElement.download = exportFileDefaultName;
                document.body.appendChild(linkElement);
                linkElement.click();
                document.body.removeChild(linkElement);
                URL.revokeObjectURL(url);
            }

            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        // Basic validation
                        if (typeof importedData !== 'object' || importedData === null) {
                            throw new Error('Invalid backup file format.');
                        }

                        if (confirm('Importing this file will overwrite all your current data. Are you sure you want to proceed?')) {
                            // 1. Clear ALL current localStorage to avoid residue
                            localStorage.clear();

                            // 2. Set new keys from the imported data
                            for (const key in importedData) {
                                const value = importedData[key];
                                if (typeof value === 'object' && value !== null) {
                                    localStorage.setItem(key, JSON.stringify(value));
                                } else {
                                    localStorage.setItem(key, value);
                                }
                            }

                            alert('Data imported successfully. The page will now reload to apply changes.');
                            window.location.reload();
                        }
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                    // Reset input so the same file can be selected again
                    event.target.value = '';
                };
                reader.readAsText(file);
            }

            // Backup tab specific listeners
            document.getElementById('exportJsonBtn').addEventListener('click', exportData);
            document.getElementById('importJsonBtn').addEventListener('click', () => {
                document.getElementById('importFile').click();
            });
            document.getElementById('importFile').addEventListener('change', importData);

            // **MODIFIED:** General click handler now also handles the Day A/B clear button
            mainContent.addEventListener('click', (event) => {
                const target = event.target;

                // 1. Individual Task Delete Button (Tracker Tabs)
                if (target.classList.contains('delete-btn')) {
                    const itemId = target.getAttribute('data-id');
                    const trackerType = target.getAttribute('data-type');
                    deleteTrackerItem(itemId, trackerType);
                    return;
                }

                // 2. **NEW** Day A/B Card Delete Button (Task View)
                if (target.classList.contains('delete-course-card-btn') && target.hasAttribute('data-day')) {
                    const courseName = target.getAttribute('data-course');
                    const dayId = target.getAttribute('data-day');
                    const courseCard = target.closest('.course-card');

                    if (confirm(`Are you sure you want to clear the tasks for "${courseName}" on ${dayId.replace('day', 'Day ')}?`)) {
                        deleteDayTaskCard(courseCard);
                    }
                    return;
                }

                // 3. Course Card Delete Button (Tracker Tabs - deletes all tasks for the course)
                if (target.classList.contains('delete-course-card-btn') && !target.hasAttribute('data-day')) {
                    const courseName = target.getAttribute('data-course');
                    const trackerType = target.getAttribute('data-type');
                    deleteTrackerCourse(courseName, trackerType);
                    return;
                }
            });

            // *** NEW: Delegated contextmenu listener for Tracker Cards to fix bug and handle positioning ***
            // The original logic for checking the target and preventing default is fine.
            mainContent.addEventListener('contextmenu', (e) => {
                // First, check for day card course titles (Day A/B cards)
                const dayCardH3 = e.target.closest('.course-card h3');
                const dayCard = e.target.closest('.course-card[data-day]'); // Only course cards with data-day attribute

                if (dayCardH3 && dayCard) {
                    e.preventDefault();
                    const courseName = dayCard.getAttribute('data-course-name');
                    const dayId = dayCard.getAttribute('data-day');
                    showDayCardContextMenu(e, courseName, dayId, dayCardH3);
                    return;
                }

                // Otherwise, check for tracker card course titles
                const trackerH3 = e.target.closest('.tracker-course-card h3');
                const trackerCard = e.target.closest('.tracker-course-card');

                if (trackerH3 && trackerCard) {
                    // This is a right-click on the course title inside a tracker card
                    e.preventDefault(); // Prevent default browser menu

                    // Use the reliable data attribute on the card
                    const courseName = trackerCard.getAttribute('data-course-name');

                    // Determine the tracker type
                    const trackerType = trackerCard.closest('.tab-content').id === 'lessonTracker' ? 'lesson' : 'assignment';

                    // Ensure we are in a tracker tab before showing the menu
                    if (trackerType) {
                        // Pass the H3 element for correct positioning
                        showPauseContextMenu(e, courseName, trackerType, trackerH3);
                    }
                }
            });

            // **NEW:** Left-click handler to open links
            mainContent.addEventListener('click', (e) => {
                const courseLink = e.target.closest('.course-card a.course-link, .tracker-course-card a.course-link');

                if (courseLink) {
                    e.preventDefault();
                    window.open(courseLink.href, '_blank');
                }
            });


            // Attach listeners for Status Toggle (Change)
            mainContent.addEventListener('change', (event) => {
                if (event.target.classList.contains('tracker-item-checkbox')) {
                    const checkbox = event.target;
                    const itemId = checkbox.getAttribute('data-id');
                    const trackerType = checkbox.getAttribute('data-type');
                    toggleTrackerItemStatus(itemId, trackerType);
                }
            });


            // Pie Chart Drawing Function (MODIFIED color for Not Started)
            function drawPieChart(canvas, finishedCount, notStartedCount) {
                const ctx = canvas.getContext('2d');
                const total = finishedCount + notStartedCount;
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = Math.min(centerX, centerY) * 0.9;

                const PIE_RED_COLOR = '#EA4335'; // Red Color for 'Not Started' status

                // Clear the canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                let currentAngle = 0;

                // Finished items (Green)
                const finishedRatio = total > 0 ? finishedCount / total : 0;
                let sliceAngle = finishedRatio * 2 * Math.PI;

                ctx.fillStyle = '#58A65C'; // Green
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fill();

                currentAngle += sliceAngle;

                // Not Started items (Red)
                const notStartedRatio = total > 0 ? notStartedCount / total : 0;
                sliceAngle = notStartedRatio * 2 * Math.PI;

                ctx.fillStyle = PIE_RED_COLOR; // Use the new red color
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fill();
            }

            // **NEW:** Generate Progress Circle HTML for Split Assignments
            function generateProgressCircleHTML(courseName, assignmentName, splitData, itemId, type) {
                const { totalDays, completedDays } = splitData;
                const isComplete = completedDays >= totalDays;
                const progress = completedDays / totalDays;

                // SVG circle properties
                const radius = 11.5;
                const circumference = 2 * Math.PI * radius;
                const strokeDashoffset = circumference * (1 - progress);

                // Determine the stroke color class
                let strokeColorClass = 'in-progress';
                if (isComplete) {
                    // Use tracker green for assignment tracker
                    strokeColorClass = 'completed-tracker';
                }

                return `
                    <div class="progress-circle-wrapper ${isComplete ? 'completed' : ''}" 
                         data-course="${courseName}" 
                         data-assignment="${assignmentName}"
                         data-id="${itemId}"
                         data-type="${type}"
                         data-total="${totalDays}"
                         data-completed="${completedDays}">
                        <svg class="progress-circle-svg" viewBox="0 0 25 25">
                            <circle class="progress-circle-bg" cx="12.5" cy="12.5" r="${radius}"></circle>
                            <circle class="progress-circle-progress ${strokeColorClass}" 
                                    cx="12.5" cy="12.5" r="${radius}"
                                    stroke-dasharray="${circumference}"
                                    stroke-dashoffset="${strokeDashoffset}">
                            </circle>
                        </svg>
                        <div class="progress-circle-checkmark" 
                             style="opacity: ${isComplete ? '1' : (completedDays >= 1 ? '0.5' : '0')}"></div>
                        <input type="checkbox" 
                               class="split-assignment-checkbox" 
                               data-course="${courseName}" 
                               data-assignment="${assignmentName}"
                               data-id="${itemId}"
                               data-type="${type}"
                               ${isComplete ? 'checked' : ''}>
                    </div>
                `;
            }

            // Main Tracker Renderer Function (MODIFIED for pause status and progress calc)
            function renderTracker(type) {
                const storageKey = type === 'lesson' ? LS_LESSONS_KEY : LS_ASSIGNMENTS_KEY;
                const contentContainer = document.getElementById(`${type}TrackerContent`);
                const data = JSON.parse(localStorage.getItem(storageKey)) || [];
                // Only need to check one type due to sync
                const pausedCourses = getPausedCourses().lesson || [];

                contentContainer.innerHTML = '';

                // Group data by course
                const dataByCourse = ALL_COURSE_NAMES.reduce((acc, course) => {
                    acc[course] = data.filter(item => item.course === course);
                    return acc;
                }, {});

                // **NEW:** Sort courses so unpaused come first, then paused (both alphabetically)
                const coursesToRender = ALL_COURSE_NAMES.filter(course => dataByCourse[course].length > 0);
                const unpausedCourses = coursesToRender.filter(course => !pausedCourses.includes(course)).sort();
                const pausedCoursesToRender = coursesToRender.filter(course => pausedCourses.includes(course)).sort();
                const sortedCourses = [...unpausedCourses, ...pausedCoursesToRender];

                // Render a card for each course
                sortedCourses.forEach(course => {
                    const courseData = dataByCourse[course];
                    if (courseData.length === 0) return;

                    // NEW: Determine Pause State (Check against the synced lesson list)
                    const isPaused = pausedCourses.includes(course);
                    const pausedClass = isPaused ? 'paused' : '';
                    const pauseBadgeHTML = isPaused ? `<span class="pause-badge">PAUSED</span>` : '';

                    // Filter data for active items (paused courses have 0 active items)
                    const activeCourseData = isPaused ? [] : courseData;

                    // Calculate progress based on active data
                    const activeFinishedCount = activeCourseData.filter(item => item.status === 'Finished').length;
                    const totalActiveCount = activeCourseData.length;
                    const percentageFinished = totalActiveCount > 0 ? ((activeFinishedCount / totalActiveCount) * 100).toFixed(0) : 0;

                    // Total tasks in the card (for context)
                    const totalCardCount = courseData.length;

                    // Full finished count for X button logic (should ignore pause state)
                    const fullFinishedCount = courseData.filter(item => item.status === 'Finished').length;

                    // Logic for delete button visibility
                    const isCompleted = totalCardCount > 0 && fullFinishedCount === totalCardCount;
                    const completionClass = isCompleted ? 'completed' : '';
                    const deleteButtonHTML = `
                        <button 
                            class="delete-course-card-btn ${completionClass}" 
                            data-course="${course}" 
                            data-type="${type}"
                            title="Delete all tasks for this course"
                        >
                            &times; 
                        </button>
                    `;

                    const card = document.createElement('div');
                    // MODIFICATION: Add pausedClass to the card's class list
                    card.className = `tracker-course-card ${pausedClass}`;
                    // NEW: Add data-course-name attribute for reliable identification
                    card.setAttribute('data-course-name', course);

                    // Header and Summary
                    // MODIFICATION: Add pause badge next to H3 and update summary text
                    let cardHTML = `
                        <h3>${course} ${pauseBadgeHTML}</h3> 
                        ${deleteButtonHTML} 
                        <div class="tracker-summary">
                            ${isPaused
                            ? `All ${totalCardCount} tasks paused. (Right-click course title to unpause)`
                            : `${activeFinishedCount} of ${totalCardCount} active ${type}s finished (${percentageFinished}%)`
                        }
                        </div>
                        <div class="chart-container">
                            <canvas id="chart-${type}-${course.replace(/\s/g, '-')}" width="150" height="150"></canvas>
                        </div>
                    `;

                    // Start of List (using <ul> with display: grid)
                    let listHTML = `
                        <ul>
                            <div class="tracker-grid-header">
                                <div>${type === 'lesson' ? 'Lesson Name' : 'Assignment Name'}</div>
                                <div>Status</div>
                                <div>Actions</div>
                            </div>
                    `;

                    // List of items - Use full courseData here
                    courseData.forEach(item => {
                        const isChecked = item.status === 'Finished';

                        // Check if this is a split assignment (only for assignment type)
                        const splitData = type === 'assignment' ? getSplitAssignment(course, item.name) : null;

                        let statusHTML;
                        if (splitData) {
                            // Generate progress circle for split assignment
                            statusHTML = generateProgressCircleHTML(course, item.name, splitData, item.id, type);
                        } else {
                            // Regular checkbox
                            statusHTML = `
                                <input 
                                    type="checkbox" 
                                    class="tracker-item-checkbox" 
                                    data-id="${item.id}" 
                                    data-type="${type}"
                                    ${isChecked ? 'checked' : ''}
                                >
                            `;
                        }

                        const indentStyle = item.isIndented ? 'padding-left: 24px;' : item.isOutdented ? 'padding-left: 0;' : '';

                        // User requested to remove bracketed types ([Assignment]) from the tracker list view
                        const typeLabel = '';

                        listHTML += `
                            <div class="tracker-item-row" data-id="${item.id}" data-type="${type}" data-course="${course}" data-name="${item.name}">
                                <div class="tracker-item-name" style="${indentStyle}">${typeLabel}${item.name}</div>
                                <div>${statusHTML}</div>
                                <div> 
                                    <button class="delete-btn" data-id="${item.id}" data-type="${type}">Delete</button>
                                </div>
                            </div>
                        `;
                    });

                    listHTML += `</ul>`;
                    card.innerHTML = cardHTML + listHTML;
                    contentContainer.appendChild(card);

                    // Draw the chart
                    setTimeout(() => {
                        const canvas = document.getElementById(`chart-${type}-${course.replace(/\s/g, '-')}`);
                        if (canvas) {
                            if (!isPaused) {
                                // Draw pie chart using full counts (finished vs not finished)
                                drawPieChart(canvas, fullFinishedCount, totalCardCount - fullFinishedCount);
                            } else {
                                // Draw a solid gray circle if paused
                                const ctx = canvas.getContext('2d');
                                const centerX = canvas.width / 2;
                                const centerY = canvas.height / 2;
                                const radius = Math.min(centerX, centerY) * 0.9;
                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                                ctx.fillStyle = '#CCCCCC';
                                ctx.beginPath();
                                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                                ctx.closePath();
                                ctx.fill();
                            }
                        }
                    }, 0);
                });

                calculateAndRenderOverallProgress(type);
            }

            // --- Custom Context Menu Logic ---
            const contextMenu = document.getElementById('trackerContextMenu');
            const pauseUnpauseBtn = document.getElementById('pauseUnpauseBtn');
            let contextMenuCourseName = '';
            let contextMenuTrackerType = '';

            // **NEW:** Day Card Context Menu Logic
            const dayCardContextMenu = document.getElementById('dayCardContextMenu');
            const addEditLinkBtn = document.getElementById('addEditLinkBtn');
            const removeLinkBtn = document.getElementById('removeLinkBtn');
            let dayCardContextMenuCourseName = '';
            let dayCardContextMenuDayId = '';

            function showDayCardContextMenu(e, courseName, dayId, h3Element) {
                dayCardContextMenuCourseName = courseName;
                dayCardContextMenuDayId = dayId;

                const hasLink = hasCustomLink(courseName);
                removeLinkBtn.style.display = hasLink ? 'block' : 'none';

                const rect = h3Element.getBoundingClientRect();
                dayCardContextMenu.style.left = `${rect.left}px`;
                dayCardContextMenu.style.top = `${rect.bottom + 5}px`;
                dayCardContextMenu.style.display = 'block';
            }

            // Handle Add/Edit Link
            addEditLinkBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openLinkModal(dayCardContextMenuCourseName);
                dayCardContextMenu.style.display = 'none';
            });

            // Handle Remove Link
            removeLinkBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm(`Remove link from "${dayCardContextMenuCourseName}"?`)) {
                    deleteCustomLink(dayCardContextMenuCourseName);
                    updateCourseH3Href(dayCardContextMenuCourseName);
                }
                dayCardContextMenu.style.display = 'none';
            });

            // MODIFIED: Added h3Element parameter for positioning
            function showPauseContextMenu(e, courseName, type, h3Element) {
                // The e.preventDefault() is now done in the delegated listener

                contextMenuCourseName = courseName;
                contextMenuTrackerType = type;

                // Check pause state against the *synced* list (lesson)
                const pausedCourses = getPausedCourses().lesson || [];
                const isPaused = pausedCourses.includes(courseName);

                pauseUnpauseBtn.textContent = isPaused ? 'Unpause Course' : 'Pause Course';
                pauseUnpauseBtn.classList.add('pause-action');

                // **MODIFIED POSITIONING LOGIC FOR FIXED, ZOOM-RESISTANT PLACEMENT**
                const rect = h3Element.getBoundingClientRect();

                // Position the menu: fixed position, 5px below the H3 element, aligned to its left edge
                contextMenu.style.left = `${rect.left}px`;
                contextMenu.style.top = `${rect.bottom + 5}px`; // 5px below the H3 element
                contextMenu.style.display = 'block';
            }

            // Hide menu on any click outside
            document.addEventListener('click', () => {
                contextMenu.style.display = 'none';
                dayCardContextMenu.style.display = 'none';
                assignmentContextMenu.style.display = 'none';
                lessonContextMenu.style.display = 'none'; // Hide lesson context menu
            });

            // **NEW:** Assignment Context Menu Logic (for Assignment Tracker only)
            const assignmentContextMenu = document.getElementById('assignmentContextMenu');
            const splitAssignmentBtn = document.getElementById('splitAssignmentBtn');
            const completeNowBtn = document.getElementById('completeNowBtn');
            const resetSplitBtn = document.getElementById('resetSplitBtn');
            let assignmentContextMenuData = { courseName: '', assignmentName: '', itemId: '' };

            function showAssignmentContextMenu(e, courseName, assignmentName, itemId, targetElement) {
                assignmentContextMenuData = { courseName, assignmentName, itemId };

                const rect = targetElement.getBoundingClientRect();
                assignmentContextMenu.style.left = `${rect.left}px`;
                assignmentContextMenu.style.top = `${rect.bottom + 5}px`;
                assignmentContextMenu.style.display = 'block';

                // Update menu text based on current state
                const splitData = getSplitAssignment(courseName, assignmentName);
                if (splitData) {
                    splitAssignmentBtn.textContent = 'Edit Splitâ€¦';
                    completeNowBtn.style.display = 'block';
                    resetSplitBtn.style.display = 'block';
                } else {
                    splitAssignmentBtn.textContent = 'Split Assignmentâ€¦';
                    completeNowBtn.style.display = 'none';
                    resetSplitBtn.style.display = 'none';
                }
            }

            // Handle Split Assignment button click
            splitAssignmentBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openSplitModal(assignmentContextMenuData.courseName, assignmentContextMenuData.assignmentName);
                assignmentContextMenu.style.display = 'none';
            });

            // Handle Complete Now button click
            completeNowBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const { courseName, assignmentName, itemId } = assignmentContextMenuData;

                // Complete the split assignment
                completeSplitAssignmentNow(courseName, assignmentName);

                // Mark the assignment as finished in tracker
                toggleTrackerItemStatus(itemId, 'assignment');

                // Sync to Day Cards (ensure X button appears)
                syncTrackerInputToDayCards(courseName, 'assignment', assignmentName, true);

                assignmentContextMenu.style.display = 'none';
            });

            // Handle Reset Split button click
            resetSplitBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const { courseName, assignmentName, itemId } = assignmentContextMenuData;

                // Reset the split assignment progress
                resetSplitAssignmentProgress(courseName, assignmentName);

                // Mark the assignment as Not Started in tracker
                const storageKey = LS_ASSIGNMENTS_KEY;
                let data = JSON.parse(localStorage.getItem(storageKey)) || [];
                data = data.map(item => {
                    if (item.id == itemId) {
                        item.status = 'Not Started';
                    }
                    return item;
                });
                localStorage.setItem(storageKey, JSON.stringify(data));

                // Re-render
                renderTracker('assignment');
                calculateAndRenderOverallProgress('assignment');

                // Sync to Day Cards
                syncTrackerInputToDayCards(courseName, 'assignment', assignmentName, false);

                assignmentContextMenu.style.display = 'none';
            });

            // Right-click on assignment names in Assignment Tracker
            mainContent.addEventListener('contextmenu', (e) => {
                const itemName = e.target.closest('.tracker-item-name');
                const itemRow = e.target.closest('.tracker-item-row');
                const trackerContent = e.target.closest('#assignmentTrackerContent');

                // Only show context menu for assignment names in Assignment Tracker
                if (itemName && itemRow && trackerContent) {
                    e.preventDefault();

                    const courseName = itemRow.getAttribute('data-course');
                    const assignmentName = itemRow.getAttribute('data-name');
                    const itemId = itemRow.getAttribute('data-id');

                    showAssignmentContextMenu(e, courseName, assignmentName, itemId, itemName);
                }
            });

            // **NEW:** Lesson Context Menu and Event Handlers
            const lessonContextMenu = document.getElementById('lessonContextMenu');
            const addLinksToLessonBtn = document.getElementById('addLinksToLessonBtn');
            let lessonContextMenuData = { courseName: '', lessonName: '', itemId: '' };

            function showLessonContextMenu(e, courseName, lessonName, itemId, targetElement) {
                lessonContextMenuData = { courseName, lessonName, itemId };

                const rect = targetElement.getBoundingClientRect();
                lessonContextMenu.style.left = `${rect.left}px`;
                lessonContextMenu.style.top = `${rect.bottom + 5}px`;
                lessonContextMenu.style.display = 'block';
            }

            // Handle Add Links to Lesson Name button click
            addLinksToLessonBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openLessonLinksModal(lessonContextMenuData.courseName, lessonContextMenuData.lessonName);
                lessonContextMenu.style.display = 'none';
            });

            // Right-click on lesson names in Lesson Tracker
            mainContent.addEventListener('contextmenu', (e) => {
                const itemName = e.target.closest('.tracker-item-name');
                const itemRow = e.target.closest('.tracker-item-row');
                const lessonTrackerContent = e.target.closest('#lessonTrackerContent');

                // Only show context menu for lesson names in Lesson Tracker
                if (itemName && itemRow && lessonTrackerContent) {
                    e.preventDefault();

                    const courseName = itemRow.getAttribute('data-course');
                    const lessonName = itemRow.getAttribute('data-name');
                    const itemId = itemRow.getAttribute('data-id');

                    showLessonContextMenu(e, courseName, lessonName, itemId, itemName);
                }
            });

            // **NEW:** Split Modal Dialog Logic
            const splitModal = document.getElementById('splitModal');
            const splitModalInput = document.getElementById('splitModalInput');
            const splitModalAssignmentInfo = document.getElementById('splitModalAssignmentInfo');
            const splitModalCancel = document.getElementById('splitModalCancel');
            const splitModalSave = document.getElementById('splitModalSave');
            let splitModalData = { courseName: '', assignmentName: '' };

            function openSplitModal(courseName, assignmentName) {
                splitModalData = { courseName, assignmentName };
                splitModalAssignmentInfo.textContent = `${courseName} - ${assignmentName}`;

                // Check if already split
                const existingSplit = getSplitAssignment(courseName, assignmentName);
                if (existingSplit) {
                    splitModalInput.value = existingSplit.totalDays;
                } else {
                    splitModalInput.value = 2;
                }

                splitModal.classList.add('active');
                setTimeout(() => splitModalInput.focus(), 100);
            }

            function closeSplitModal() {
                splitModal.classList.remove('active');
                splitModalInput.value = 2;
                splitModalData = { courseName: '', assignmentName: '' };
            }

            splitModalCancel.addEventListener('click', closeSplitModal);

            splitModalSave.addEventListener('click', (e) => {
                e.preventDefault();
                const totalDays = parseInt(splitModalInput.value, 10);

                if (isNaN(totalDays) || totalDays < 2 || totalDays > 30) {
                    alert('Please enter a valid number between 2 and 30');
                    return;
                }

                const { courseName, assignmentName } = splitModalData;

                // Get existing progress or start fresh
                const existingSplit = getSplitAssignment(courseName, assignmentName);
                const completedDays = existingSplit ? Math.min(existingSplit.completedDays, totalDays) : 0;

                setSplitAssignment(courseName, assignmentName, totalDays, completedDays);
                closeSplitModal();

                // Re-render the tracker
                renderTracker('assignment');

                hasUnsavedChanges = true;
            });

            splitModalInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    splitModalSave.click();
                }
            });

            // Close modal on overlay click
            splitModal.addEventListener('click', (e) => {
                if (e.target === splitModal) {
                    closeSplitModal();
                }
            });

            // **NEW:** Handle clicks on split assignment progress circles
            mainContent.addEventListener('click', (e) => {
                const progressWrapper = e.target.closest('.progress-circle-wrapper');
                const splitCheckbox = e.target.closest('.split-assignment-checkbox');

                if (progressWrapper && splitCheckbox) {
                    e.preventDefault();
                    e.stopPropagation();

                    const courseName = progressWrapper.getAttribute('data-course');
                    const assignmentName = progressWrapper.getAttribute('data-assignment');
                    const itemId = progressWrapper.getAttribute('data-id');

                    // Get current state
                    const splitData = getSplitAssignment(courseName, assignmentName);
                    if (!splitData) return;

                    let newCompleted;
                    let newStatus;

                    // Logic: If complete, reset. Else, advance.
                    if (splitData.completedDays >= splitData.totalDays) {
                        newCompleted = 0;
                        newStatus = 'Not Started';
                    } else {
                        newCompleted = splitData.completedDays + 1;
                        newStatus = newCompleted >= splitData.totalDays ? 'Finished' : 'Not Started';
                    }

                    // Save new split state
                    setSplitAssignment(courseName, assignmentName, splitData.totalDays, newCompleted);

                    // Update Tracker Status
                    const storageKey = LS_ASSIGNMENTS_KEY;
                    let data = JSON.parse(localStorage.getItem(storageKey)) || [];
                    data = data.map(item => {
                        if (item.id == itemId) {
                            item.status = newStatus;
                        }
                        return item;
                    });
                    localStorage.setItem(storageKey, JSON.stringify(data));

                    // Re-render the tracker
                    renderTracker('assignment');
                    calculateAndRenderOverallProgress('assignment');

                    // IMMEDIATE UPDATE for Day Cards
                    // Find any card for this course (there might be one in DayA and one in DayB)
                    // We must update both if they exist, or just the one we clicked
                    const dayACard = document.querySelector(`#dayA .course-card[data-course-name="${courseName}"]`);
                    const dayBCard = document.querySelector(`#dayB .course-card[data-course-name="${courseName}"]`);

                    if (dayACard) {
                        // **NEW:** Update interaction state via checkbox (checked if > 0 progress)
                        const cb = dayACard.querySelector('.task-assignment-checkbox');
                        if (cb) cb.checked = (newCompleted > 0);

                        updateDayCardSplitProgress(dayACard, courseName, assignmentName);
                        updateCardCompletionState(dayACard);
                    }
                    if (dayBCard) {
                        // **NEW:** Update interaction state via checkbox (checked if > 0 progress)
                        const cb = dayBCard.querySelector('.task-assignment-checkbox');
                        if (cb) cb.checked = (newCompleted > 0);

                        updateDayCardSplitProgress(dayBCard, courseName, assignmentName);
                        updateCardCompletionState(dayBCard);
                    }

                    hasUnsavedChanges = true;
                }
            });

            // **NEW:** Long-press handler for immediate completion
            let longPressTimer = null;
            const LONG_PRESS_DURATION = 800; // ms

            mainContent.addEventListener('mousedown', (e) => {
                const progressWrapper = e.target.closest('.progress-circle-wrapper');

                if (progressWrapper) {
                    longPressTimer = setTimeout(() => {
                        const courseName = progressWrapper.getAttribute('data-course');
                        const assignmentName = progressWrapper.getAttribute('data-assignment');
                        const itemId = progressWrapper.getAttribute('data-id');

                        // Complete immediately
                        completeSplitAssignmentNow(courseName, assignmentName);

                        // Mark the assignment as finished in tracker
                        const storageKey = LS_ASSIGNMENTS_KEY;
                        let data = JSON.parse(localStorage.getItem(storageKey)) || [];
                        data = data.map(item => {
                            if (item.id == itemId) {
                                item.status = 'Finished';
                            }
                            return item;
                        });
                        localStorage.setItem(storageKey, JSON.stringify(data));

                        // Re-render the tracker
                        renderTracker('assignment');
                        calculateAndRenderOverallProgress('assignment');

                        // Update Day Cards (Sync with tracker completion)
                        const dayACard = document.querySelector(`#dayA .course-card[data-course-name="${courseName}"]`);
                        const dayBCard = document.querySelector(`#dayB .course-card[data-course-name="${courseName}"]`);

                        if (dayACard) {
                            // **NEW:** Update interaction state - Completed = Valid Interaction
                            const cb = dayACard.querySelector('.task-assignment-checkbox');
                            if (cb) cb.checked = true;

                            updateDayCardSplitProgress(dayACard, courseName, assignmentName);
                            updateCardCompletionState(dayACard);
                        }
                        if (dayBCard) {
                            // **NEW:** Update interaction state - Completed = Valid Interaction
                            const cb = dayBCard.querySelector('.task-assignment-checkbox');
                            if (cb) cb.checked = true;

                            updateDayCardSplitProgress(dayBCard, courseName, assignmentName);
                            updateCardCompletionState(dayBCard);
                        }

                        hasUnsavedChanges = true;

                        // Prevent the click event from firing
                        e.preventDefault();
                    }, LONG_PRESS_DURATION);
                }
            });

            mainContent.addEventListener('mouseup', () => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });

            mainContent.addEventListener('mouseleave', () => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });

            // **NEW:** Link Modal Dialog Logic
            const linkModal = document.getElementById('linkModal');
            const linkModalInput = document.getElementById('linkModalInput');
            const linkModalCourseName = document.getElementById('linkModalCourseName');
            const linkModalCancel = document.getElementById('linkModalCancel');
            const linkModalSave = document.getElementById('linkModalSave');
            let modalCourseName = '';

            function openLinkModal(courseName) {
                modalCourseName = courseName;
                linkModalCourseName.textContent = courseName;
                linkModalInput.value = getCustomLink(courseName) || '';
                linkModal.classList.add('active');
                setTimeout(() => linkModalInput.focus(), 100);
            }

            function closeLinkModal() {
                linkModal.classList.remove('active');
                linkModalInput.value = '';
                modalCourseName = '';
            }

            linkModalCancel.addEventListener('click', closeLinkModal);

            linkModalSave.addEventListener('click', async (e) => {
                e.preventDefault();
                const url = linkModalInput.value.trim();

                if (!url) {
                    alert('Please enter a valid URL');
                    return;
                }

                // Ensure URL has protocol
                let fullUrl = url;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    fullUrl = 'https://' + url;
                }

                setCustomLink(modalCourseName, fullUrl);
                updateCourseH3Href(modalCourseName);
                closeLinkModal();

                // Mark as unsaved
                hasUnsavedChanges = true;
            });

            linkModalInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    linkModalSave.click();
                }
            });

            // Close modal on overlay click
            linkModal.addEventListener('click', (e) => {
                if (e.target === linkModal) {
                    closeLinkModal();
                }
            });

            // **NEW:** Lesson Links Modal Dialog Logic
            const lessonLinksModal = document.getElementById('lessonLinksModal');
            const lessonLinksModalInput = document.getElementById('lessonLinksModalInput');
            const lessonLinksModalInfo = document.getElementById('lessonLinksModalInfo');
            const lessonLinksModalCancel = document.getElementById('lessonLinksModalCancel');
            const lessonLinksModalSave = document.getElementById('lessonLinksModalSave');
            let modalLessonCourseName = '';
            let modalLessonName = '';

            function openLessonLinksModal(courseName, lessonName) {
                modalLessonCourseName = courseName;
                modalLessonName = lessonName;
                lessonLinksModalInfo.textContent = `${courseName} - ${lessonName}`;
                lessonLinksModalInput.value = getLessonLink(courseName, lessonName) || '';
                lessonLinksModal.classList.add('active');
                setTimeout(() => lessonLinksModalInput.focus(), 100);
            }

            function closeLessonLinksModal() {
                lessonLinksModal.classList.remove('active');
                lessonLinksModalInput.value = '';
                modalLessonCourseName = '';
                modalLessonName = '';
            }

            lessonLinksModalCancel.addEventListener('click', closeLessonLinksModal);

            lessonLinksModalSave.addEventListener('click', async (e) => {
                e.preventDefault();
                const linksInput = lessonLinksModalInput.value.trim();

                if (!linksInput) {
                    // Allow empty to delete links
                    deleteLessonLink(modalLessonCourseName, modalLessonName);
                } else {
                    // Process comma-separated links and ensure they have protocols
                    const links = linksInput.split(',').map(link => {
                        let trimmedLink = link.trim();
                        if (trimmedLink && !trimmedLink.startsWith('http://') && !trimmedLink.startsWith('https://')) {
                            trimmedLink = 'https://' + trimmedLink;
                        }
                        return trimmedLink;
                    }).filter(link => link.length > 0); // Remove empty links

                    if (links.length > 0) {
                        setLessonLink(modalLessonCourseName, modalLessonName, links.join(', '));
                    } else {
                        deleteLessonLink(modalLessonCourseName, modalLessonName);
                    }
                }

                closeLessonLinksModal();
                hasUnsavedChanges = true;
            });

            lessonLinksModalInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    lessonLinksModalSave.click();
                }
            });

            // Close modal on overlay click
            lessonLinksModal.addEventListener('click', (e) => {
                if (e.target === lessonLinksModal) {
                    closeLessonLinksModal();
                }
            });

            // Handle context menu button click
            pauseUnpauseBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent the body click listener from immediately hiding it
                if (contextMenuCourseName && contextMenuTrackerType) {
                    // Call the single, cross-sync function
                    toggleCoursePauseState(contextMenuCourseName, contextMenuTrackerType);
                }
                contextMenu.style.display = 'none';
            });

            // **NEW FEATURE:** Ctrl+S / Cmd+S Shortcut
            document.addEventListener('keydown', (event) => {
                // Robust Check for Ctrl/Cmd + S
                const isS = event.key === 's' || event.key === 'S' || event.code === 'KeyS';
                if ((event.ctrlKey || event.metaKey) && isS) {
                    event.preventDefault();
                    const saveBtn = document.getElementById('saveBtn');
                    if (saveBtn) saveBtn.click();
                }

                // Robust Check for Ctrl/Cmd + E for Reset
                const isE = event.key === 'e' || event.key === 'E' || event.code === 'KeyE';
                if ((event.ctrlKey || event.metaKey) && isE) {
                    event.preventDefault();
                    const resetBtn = document.getElementById('resetBtn');
                    if (resetBtn) resetBtn.click();
                }
            });

            // **NEW FEATURE:** Unsaved Changes Window Close Confirmation
            window.addEventListener('beforeunload', (event) => {
                if (hasUnsavedChanges) {
                    // Cancel the event and return a string (required by older browsers)
                    // Modern browsers ignore the custom string and display a generic message.
                    event.preventDefault();
                    event.returnValue = "Are you sure you want to leave without saving?";
                    return "Are you sure you want to leave without saving?";
                }
            });

            // **NEW:** Missing resize functions to fix text clipping on initial load
            function resizeAllDayFields() {
                // Resize all textareas in both Day A and Day B
                document.querySelectorAll('.task-list textarea').forEach(textarea => {
                    textarea.style.height = '0';
                    textarea.style.height = (textarea.scrollHeight) + 'px';
                });
            }

            function resizeFieldsForActiveDay(dayId) {
                // Resize all textareas in the specified day tab
                const dayContainer = document.getElementById(dayId);
                if (dayContainer) {
                    dayContainer.querySelectorAll('.task-list textarea').forEach(textarea => {
                        textarea.style.height = '0';
                        textarea.style.height = (textarea.scrollHeight) + 'px';
                    });
                }
            }

            // --- Initial Load ---
            // --- **NEW:** Canvas Import Logic ---

            const canvasImportBtn = document.getElementById('canvas-import-btn'); // In footer
            const canvasImportModal = document.getElementById('canvasImportModal');
            const canvasTextInput = document.getElementById('canvas-raw-text');
            const canvasPreviewContainer = document.getElementById('canvas-preview-container');
            const canvasCourseSelect = document.getElementById('canvas-import-course');
            const canvasBackBtn = document.getElementById('canvas-back-btn');
            const canvasPreviewBtn = document.getElementById('canvas-preview-btn');
            const canvasImportActionBtn = document.getElementById('canvas-import-action-btn');
            const canvasCancelBtn = document.getElementById('canvas-cancel-btn');

            let parsedCanvasData = [];

            // Open Modal
            if (canvasImportBtn) {
                canvasImportBtn.addEventListener('click', () => {
                    canvasImportModal.classList.add('active');
                    // Reset state
                    document.getElementById('canvas-step-1').style.display = 'block';
                    document.getElementById('canvas-step-2').style.display = 'none';
                    canvasTextInput.value = '';
                    parsedCanvasData = [];
                    populateCourseDropdowns(); // Ensure latest courses are available

                    // Auto-resize reset (wait for visibility)
                    setTimeout(() => {
                        canvasTextInput.style.height = '200px';
                    }, 50);
                });

                // Auto-Fit
                canvasTextInput.addEventListener('input', function () {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });

                // Indentation Toggle Logic REMOVED
            }

            // Cancel
            if (canvasCancelBtn) {
                canvasCancelBtn.addEventListener('click', () => {
                    canvasImportModal.classList.remove('active');
                });
            }

            // Preview
            if (canvasPreviewBtn) {
                canvasPreviewBtn.addEventListener('click', () => {
                    const text = canvasTextInput.value;
                    if (!text.trim()) {
                        alert('Please paste some text first.');
                        return;
                    }

                    // Use V3 Parser
                    parsedCanvasData = parseCanvasTextV3(text);
                    if (parsedCanvasData.length === 0) {
                        alert('Could not detect any lessons or assignments. Please check the format.');
                        return;
                    }

                    renderCanvasPreview(parsedCanvasData);
                    document.getElementById('canvas-step-1').style.display = 'none';
                    document.getElementById('canvas-step-2').style.display = 'block';
                });
            }

            // Back (Step 2 -> Step 1)
            if (canvasBackBtn) {
                canvasBackBtn.addEventListener('click', () => {
                    document.getElementById('canvas-step-2').style.display = 'none';
                    document.getElementById('canvas-step-1').style.display = 'block';
                });
            }

            // Import Action
            if (canvasImportActionBtn) {
                canvasImportActionBtn.addEventListener('click', () => {
                    const selectedCourse = canvasCourseSelect.value;
                    if (!selectedCourse) {
                        alert('Please select a course to import into.');
                        return;
                    }

                    importDataToCard(selectedCourse, parsedCanvasData);

                    // Non-Intrusive Feedback
                    const originalText = canvasImportActionBtn.textContent;
                    canvasImportActionBtn.textContent = 'Imported!';
                    canvasImportActionBtn.disabled = true;

                    // Console fallback
                    console.log(`Successfully imported ${parsedCanvasData.length} lessons into ${selectedCourse}.`);

                    // Close after short delay
                    setTimeout(() => {
                        canvasImportModal.classList.remove('active');
                        // Reset button state
                        canvasImportActionBtn.textContent = originalText;
                        canvasImportActionBtn.disabled = false;
                    }, 1000);
                });
            }

            // Parser Logic
            function parseCanvasText(text) {
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                const structure = [];
                let currentLesson = null;

                // Heuristics
                const lessonRegex = /^(Lesson|Chapter|Unit|Module|Week)\s+\d+/i;
                const noiseRegex = /^(View|Mark done|Submit|Contribute|Page|Quiz|Assignment|Discussion Topic|\d+\s+pts|Must\s+.*)/i;
                const typeMarkers = {
                    'Assignment': 'Assignment', // Matches exact line "Assignment"
                    'Quiz': 'Quiz',
                    'Discussion Topic': 'Discussion'
                };

                let pendingType = null;

                lines.forEach((line, index) => {
                    // 1. Detect Lesson Header
                    if (lessonRegex.test(line) || line.startsWith('Lessons ') || line.includes('Lesson ')) {
                        // Very basic heuristic: if line contains "Lesson X", assume it's a header
                        // Refined: Must start with Lesson/Chapter OR be explicitly consistent with user data
                        // User data: "Lesson 1 - Slope..."
                        currentLesson = {
                            name: line,
                            assignments: []
                        };
                        structure.push(currentLesson);
                        pendingType = null;
                        return;
                    }

                    if (!currentLesson) return;

                    // 2. Detect Type Marker (e.g. "Assignment", "Quiz")
                    if (typeMarkers[line]) {
                        pendingType = typeMarkers[line];
                        return; // The name is likely on the next line
                    }

                    // 3. Filtering Noise
                    if (noiseRegex.test(line) && !typeMarkers[line]) {
                        return;
                    }
                    if (line.match(/^\d+\s+pts$/) || line.match(/^Due\s+/)) return;

                    // 4. Capture Assignment Name
                    // If we are here, it's likely an item name
                    let type = pendingType || 'Assignment'; // Default to Assignment

                    currentLesson.assignments.push({
                        type: type,
                        name: line
                    });

                    pendingType = null;
                });

                return structure;
            }

            // **NEW PARSER V3:** Enhanced Logic for Headers, LaTeX, and Status
            function parseCanvasTextV3(text) {
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                const structure = [];
                let currentLesson = null;

                // Helper: Clean Text (LaTeX, Emojis)
                const cleanText = (str) => {
                    if (!str) return '';
                    // simplistic LaTeX unwrap: \cmd{text} -> text
                    let oldStr;
                    do {
                        oldStr = str;
                        str = str.replace(/\\[a-zA-Z]+{([^{}]*)}/g, '$1');
                    } while (str !== oldStr);

                    // Remove standalone commands and braces
                    str = str.replace(/\\[a-zA-Z]+/g, '').replace(/[{}]/g, '');

                    // Remove Emojis (Broad Unicode Ranges)
                    str = str.replace(/[\u{1F600}-\u{1F64F}]/gu, '') // Emoticons
                        .replace(/[\u{1F300}-\u{1F5FF}]/gu, '') // Misc Symbols and Pictographs
                        .replace(/[\u{1F680}-\u{1F6FF}]/gu, '') // Transport and Map
                        .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '') // Flags
                        .replace(/[\u{2600}-\u{26FF}]/gu, '')   // Misc Symbols
                        .replace(/[\u{2700}-\u{27BF}]/gu, '');  // Dingbats

                    return str.trim();
                };

                // Helper: Normalize Status (Returns Object)
                const normalizeStatus = (str) => {
                    if (!str) return null;
                    if (/Submitted/i.test(str)) return { text: 'Submit', done: true };
                    if (/Submit/i.test(str)) return { text: 'Submit', done: false }; // "Must submit"
                    if (/Marked done/i.test(str)) return { text: 'Mark Done', done: true };
                    if (/Mark.*done/i.test(str)) return { text: 'Mark Done', done: false }; // "Must mark done"
                    if (/Viewed/i.test(str)) return { text: 'Viewed', done: true };
                    if (/Contribute/i.test(str)) return { text: 'Contribute', done: false };
                    return null;
                };

                // Mode Detection: Do we have explicit headers?
                const useSubHeader = lines.some(l => l.includes('Context Module Sub Header'));
                let isExplicitLesson = false; // Track if current lesson is a real Header or just a standalone item wrapper

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];

                    // 1. Header Detection (Explicit)
                    if (useSubHeader && line === 'Context Module Sub Header') {
                        if (lines[i + 1]) {
                            const title = cleanText(lines[i + 1]);
                            currentLesson = { name: title, items: [] };
                            structure.push(currentLesson);
                            isExplicitLesson = true; // Mark as explicit header
                            i++; // Skip title
                            continue;
                        }
                    }

                    // 2. Item Detection Strategies
                    const isPage = line === 'Page';
                    const isAssignment = line === 'Assignment' || line === 'Quiz' || line === 'Discussion Topic' || line === 'Attachment' || line === 'External Url';

                    if (isPage || isAssignment) {
                        const type = line === 'External Url' ? 'Link' : (line === 'Attachment' ? 'File' : line);
                        if (lines[i + 1]) {
                            const rawTitle = lines[i + 1];
                            const title = cleanText(rawTitle);
                            i++; // Skip title

                            // 3. Header Detection (Implicit OR Explicit override)
                            // If title starts with "Lesson X", treat as Lesson Group
                            if (isAssignment && /^Lesson\s+/i.test(title)) {
                                // User Rule: "If an assignment name begins with 'Lesson'... treated as a separate, distinct lesson"
                                currentLesson = { name: title, items: [] };
                                structure.push(currentLesson);
                                isExplicitLesson = true;
                                continue;
                            }

                            // 3b. Header Detection (Implicit - Page with "Lesson/Unit/Chapter/Week")
                            // Only if NOT using SubHeaders (or fallback)
                            // Relaxed regex to support "Lesson Three" (Word numbers) or just "Lesson ..."
                            if (!useSubHeader && isPage && /^(Lesson|Unit|Chapter|Week|Module)\s+/i.test(title)) {
                                currentLesson = { name: title, items: [] };
                                structure.push(currentLesson);
                                isExplicitLesson = true;
                                // Treat this Page as the Lesson Concept, not an item to do
                                continue;
                            }

                            // 4. Add Item to Current Lesson
                            // Fallback: If no lesson exists yet OR if we are in "Standalone Mode" (Orphaned Items)
                            // User Request: "The general/imported items should be separated... each assignment must be treated as a standalone item"
                            if (!currentLesson || !isExplicitLesson) {
                                // Create a new lesson for THIS item (Standalone)
                                currentLesson = { name: title, items: [] };
                                structure.push(currentLesson);
                                isExplicitLesson = false; // Still not explicit, so next item will ALSO trigger new structure
                            }

                            if (currentLesson) {
                                let statusObj = null;
                                let metaLinesProcessed = 0;

                                // Check i+1 (Points or Status)
                                if (lines[i + 1]) {
                                    const next = lines[i + 1];
                                    const s = normalizeStatus(next);
                                    if (s) {
                                        statusObj = s;
                                        metaLinesProcessed++;
                                    } else if (/\d+\s+pts/.test(next) || /\d+\s+min/.test(next)) {
                                        // Points line
                                        metaLinesProcessed++;
                                        if (lines[i + 2]) {
                                            const s2 = normalizeStatus(lines[i + 2]);
                                            if (s2) {
                                                statusObj = s2;
                                                metaLinesProcessed++;
                                            }
                                        }
                                    }
                                }

                                i += metaLinesProcessed;

                                let mappedType = 'assignment';
                                if (line === 'Quiz') mappedType = 'quiz';
                                if (line === 'Discussion Topic') mappedType = 'discussion';

                                currentLesson.items.push({
                                    title: title,
                                    type: mappedType,
                                    status: statusObj ? statusObj.text : '',
                                    isDone: statusObj ? statusObj.done : false
                                });
                            }
                        }
                    }
                }

                return structure;
            }
            function renderCanvasPreview(data) {
                canvasPreviewContainer.innerHTML = '';
                if (!data || data.length === 0) {
                    canvasPreviewContainer.innerHTML = '<p style="color:#666; font-style:italic;">No lessons detected.</p>';
                    return;
                }

                data.forEach(lesson => {
                    const lessonDiv = document.createElement('div');
                    lessonDiv.className = 'canvas-tree-lesson';

                    // Check for Standalone/Redundant Case
                    // If 1 item AND Lesson Name == Item Title (or close enough) -> Hide Header
                    let hideHeader = false;
                    if (lesson.items && lesson.items.length === 1) {
                        if (lesson.name === lesson.items[0].title) {
                            hideHeader = true;
                        }
                    } else if (lesson.assignments && lesson.assignments.length === 1) {
                        // Fallback for V2
                        if (lesson.name === lesson.assignments[0].name) {
                            hideHeader = true;
                        }
                    }

                    if (!hideHeader) {
                        lessonDiv.innerHTML = `<strong>${lesson.name}</strong>`;
                    }

                    if (lesson.items && lesson.items.length > 0) {
                        lesson.items.forEach(item => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'canvas-tree-item';
                            if (item.isIndented) itemDiv.classList.add('manual-indent');
                            if (item.isOutdented) itemDiv.classList.add('force-no-indent');

                            const dType = (item.type || 'Assignment').charAt(0).toUpperCase() + (item.type || 'Assignment').slice(1);

                            // Format: Type Title (Status)
                            let text = `<span class="canvas-tree-type">${dType}</span> <span class="canvas-preview-title">${item.title}</span>`;
                            if (item.status) {
                                text += ` <span style="font-size:0.85em; color:#27ae60; font-weight:600;">(${item.status})</span>`;
                            }
                            itemDiv.innerHTML = text;

                            // **NEW:** Restricted Indentation Cycle in Preview
                            const titleSpan = itemDiv.querySelector('.canvas-preview-title');

                            // Determine if standalone
                            const isStandalone = hideHeader;

                            if (isStandalone) {
                                titleSpan.style.cursor = 'default';
                                titleSpan.removeAttribute('title');
                            } else {
                                titleSpan.style.cursor = 'pointer';
                                titleSpan.title = 'Click to toggle indentation';
                                titleSpan.onclick = function () {
                                    // Logic: Only toggle between "Default" and "Outdented"
                                    if (itemDiv.classList.contains('force-no-indent')) {
                                        itemDiv.classList.remove('force-no-indent');
                                        item.isOutdented = false;
                                    } else {
                                        itemDiv.classList.add('force-no-indent');
                                        item.isOutdented = true;
                                        itemDiv.classList.remove('manual-indent');
                                        item.isIndented = false;
                                    }
                                };
                            }

                            // **NEW:** Type Cycling in Preview
                            const typeSpan = itemDiv.querySelector('.canvas-tree-type');
                            typeSpan.style.cursor = 'pointer';
                            typeSpan.title = 'Click to cycle type';
                            typeSpan.onclick = function () {
                                const types = ['Assignment', 'Quiz', 'Discussion'];
                                let current = typeSpan.textContent.trim();
                                let idx = (types.indexOf(current) + 1) % types.length;
                                typeSpan.textContent = `${types[idx]}`;
                                item.type = types[idx].toLowerCase();
                            };

                            lessonDiv.appendChild(itemDiv);
                        });
                    } else if (lesson.assignments) {
                        // Fallback for V2 structure (if any legacy data persists in memory)
                        lesson.assignments.forEach(assign => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'canvas-tree-item';
                            const dType = (assign.type || 'Assignment').charAt(0).toUpperCase() + (assign.type || 'Assignment').slice(1);
                            itemDiv.textContent = `${dType} ${assign.name}`;
                            lessonDiv.appendChild(itemDiv);
                        });
                    }

                    canvasPreviewContainer.appendChild(lessonDiv);
                });
            }

            function importDataToCard(courseName, data) {
                const mapKey = 'tracker_lesson_assignments_map';
                const mapping = JSON.parse(localStorage.getItem(mapKey)) || {};

                // Optimization: Read trackers once
                const existingLessons = new Set((JSON.parse(localStorage.getItem(LS_LESSONS_KEY)) || []).filter(i => i.course === courseName).map(i => i.name));
                const existingAssignments = new Set((JSON.parse(localStorage.getItem(LS_ASSIGNMENTS_KEY)) || []).filter(i => i.course === courseName).map(i => i.name));

                data.forEach(lesson => {
                    const key = `${courseName}::${lesson.name}`; // Course::LessonName key

                    // Handle V3 'items' vs V2 'assignments'
                    const items = lesson.items || lesson.assignments || [];

                    // User Request: If outdented, don't link to lesson.
                    // Filter items to only include those that are NOT specifically outdented.
                    const assignmentNames = items
                        .filter(a => !a.isOutdented)
                        .map(a => a.title || a.name);

                    // Check for Standalone/Redundant Case
                    // If 1 item AND Lesson Name == Item Title -> It's just an assignment
                    let isStandalone = false;
                    if (items.length === 1 && (lesson.name === items[0].title || lesson.name === items[0].name)) {
                        isStandalone = true;
                    }

                    // Store mapping (still useful for internal lookups even if not in Lesson list)
                    mapping[key] = assignmentNames;

                    // Add to Lesson Tracker (ONLY if NOT standalone)
                    if (!isStandalone && !existingLessons.has(lesson.name)) {
                        // For Lesson Status: We don't really have a "Lesson Status" in raw data directly attached to the header usually,
                        // unless we infer from all items being done. For now, defaulting to false unless we add logic.
                        updateTrackerItemStatusFromCard(courseName, 'lesson', lesson.name, false);
                        existingLessons.add(lesson.name);
                    }

                    // Add to Assignment Tracker (if not exists)
                    items.forEach(item => {
                        const aName = item.title || item.name;

                        // Fix Status
                        const isDone = item.isDone === true; // Strict check
                        const isIndented = item.isIndented === true;
                        const isOutdented = item.isOutdented === true;
                        const itemType = item.type || 'assignment';

                        // We update status regardless of existence?
                        // If it exists but was unchecked, and now we import with "Submitted", should we check it?
                        // Yes, likely.
                        if (!existingAssignments.has(aName) || isDone || isIndented || isOutdented || itemType !== 'assignment') {
                            updateTrackerItemStatusFromCard(courseName, 'assignment', aName, isDone, isIndented, isOutdented, itemType);
                            existingAssignments.add(aName);
                        }
                    });
                });

                localStorage.setItem(mapKey, JSON.stringify(mapping));

                // Refresh current view
                renderTracker('lesson');
                renderTracker('assignment');
            }

            populateCourseDropdowns();
            loadData();
        });
    </script>
</body>

</html>